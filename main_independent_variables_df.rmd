---
title: "main_independent_variables"
author: "MNB"
date: "4/18/2024"
output: html_document
---


## Libraries
```{r}
library(Hmisc)
library(data.table)

library(R.utils)
library(plyr)
library(dplyr)
library(tidyverse)
library(tidyr)
library(naniar)
library(geosphere)
library(zoo)
library(stringr)
library(tidytext)
library(rworldmap)
library(gridExtra)


library(classInt)
library("ggplot2")
library(devtools)
library(DT)
library(dvmisc)
library(ggpubr)
library(gtools)
library(foreign)
#library(GADMTools)
library(maps)


library(spdep)
library(lubridate)


library(WDI)
library(readxl)
library(haven)


library(reshape)

library(geojsonio)

library(countrycode)

library(roll)
```

# Remove lists 
```{r, include=FALSE}
## remove lists
rm(list=ls())
```

# Funtions 
```{r}
# calculate mode
mode <- function(v) {
  uniqv <- unique(v)
  uniqv[which.max(tabulate(match(v, uniqv)))]
}


# exclude
'%!in%' <- function(x,y)!('%in%'(x,y))

drop_columns <- function(data, columns_to_drop) {
  data <- data[, names(data) %!in% columns_to_drop, drop = FALSE]
  return(data)
}


## drop NAs from column
Drop_NA <- function(dataset, col_name){
  col_name <- enquo(col_name)
  dataset %>%
    drop_na((!!col_name)) %>%
    as.data.frame()
}

## create 1 and 2 period lags (grouping by a variable)
Lag_12 <- function(dataset,col_name,x){
  {
    col_name <- enquo(col_name)
    dataset %>%
      group_by(!!col_name) %>%
      mutate(across(all_of(x),
                    .fns = ~ lag(.,1),
                    .names = paste0("{.col}_lag_",1)))%>%
      mutate(across(all_of(x),
                    .fns = ~ lag(.,2),
                    .names = paste0("{.col}_lag_",2)))
    
  } 
}

## create 1 and 2 period lags 
Lag_12_ngby <- function(dataset,x){
  {
    dataset %>%
      mutate(across(all_of(x),
                    .fns = ~ lag(.,1),
                    .names = paste0("{.col}_lag_",1)))%>%
      mutate(across(all_of(x),
                    .fns = ~ lag(.,2),
                    .names = paste0("{.col}_lag_",2)))
    
  } 
}

## assign 0 to NAs
Nas_to_0 <- function(dataset, x) {
  
  dataset %>% mutate_at(all_of(x), ~replace(., is.na(.), 0))
  
}


download_and_create_folder <- function(file_name, desktop_path, folder_name, url) {
  
  # Combine the desktop path with the folder name
  folder_path <- file.path(desktop_path,main_folder_name, folder_name)
  
  
  # Check if the folder exists
  if (!file.exists(folder_path)) {
    # If the folder doesn't exist, create it
    dir.create(folder_path)
    cat("Folder", folder_path, "created.\n")
  } else {
    # If the folder already exists, do nothing
    cat("Folder", folder_path, "already exists.\n")
  }
  
  # Specify the file path where you want to save the downloaded file
  file_path <- paste0(folder_path, "/", file_name)
  
  # Download the file
  download.file(url, file_path, mode = "wb")
}




download_create_folder_and_unzip <- function(desktop_path, folder_name, url) {
  
  # Combine the desktop path with the folder name
  folder_path <- file.path(desktop_path,main_folder_name, folder_name)
  
  
  # Check if the folder exists
  if (!file.exists(folder_path)) {
    # If the folder doesn't exist, create it
    dir.create(folder_path)
    cat("Folder", folder_path, "created.\n")
  } else {
    # If the folder already exists, do nothing
    cat("Folder", folder_path, "already exists.\n")
  }
  
  # Specify the file path where you want to save the downloaded file
  file_path <- folder_path
  
  # Download the file
  download.file(url, destfile = "temp.zip", mode = "wb")
  
  # Unzip the downloaded file
  unzip("temp.zip", exdir = file_path)
  
  # Delete the temporary zip file
  file.remove("temp.zip")
}

```



# Setting directory for datasets' folders
```{r}
desktop_path <- file.path("C:", "Users", "marco", "Desktop")
#desktop_path <- file.path("C:", "Users","krogers","Documents")
```


# Set main folder name
```{r}
# Define the name of the folder to check/create
main_folder_name <- "DFGlobalLab"
#main_folder_name <- "data"
```

# Creating folder for datasets
```{r}

# Combine the desktop path with the folder name
folder_path <- file.path(desktop_path, main_folder_name)

# Check if the folder exists
if (!file.exists(folder_path)) {
  # If the folder doesn't exist, create it
  dir.create(folder_path)
  cat("Folder", main_folder_name, "created on the desktop.\n")
} else {
  # If the folder already exists, do nothing
  cat("Folder", main_folder_name, "already exists on the desktop.\n")
}
```

# Importing and reshaping Dfs

### Polity 2
#### Set subfolder name
```{r}
sub_folder_name<-"polity2"
```

#### Create folder and download
```{r}
download_and_create_folder("p5v2018.xls",
                           desktop_path,
                           sub_folder_name,
                           "http://www.systemicpeace.org/inscr/p5v2018.xls")
```

#### Import
```{r}
file_path<-file.path(desktop_path,main_folder_name, sub_folder_name, "p5v2018.xls")
## import  dataset
Polity2<- read_excel(file_path)
```

# Create bases - at year and month levels
```{r}
df_Polity2<-Polity2

# Create base at year level
## subset years of interests
df_Polity2<-subset(df_Polity2, df_Polity2$year>1980 & Polity2$year<2020)

# Rename countries
  replacements <- c(
    "Czechoslovakia" = "Czech Republic (the)",
    "Serbia Montenegro" = "Serbia",
    "Yugoslavia" = "Serbia"
  )
  df_Polity2$country <- ifelse(df_Polity2$country %in% names(replacements), replacements[df_Polity2$country], df_Polity2$country)

## assign ISO3C
df_Polity2$iso3c <- countrycode(df_Polity2$country, "country.name", "iso3c")

## subset only columns of interest
df_Base_Y<-df_Polity2[c("country",
                        "iso3c",
                        "year")]

# Complete panel
df_Base_Y<-df_Base_Y %>%
  complete(iso3c,year=c(1981:2021)) %>%
  group_by(iso3c) %>% fill(country) %>%
  ungroup()

## drop iso3c NA
df_Base_Y<-Drop_NA(df_Base_Y, iso3c)

#drop duplicates (usual yuogoslavia and soviet union "problem" with name change to serbia and russia)
df_Base_Y<-df_Base_Y %>% 
                distinct(year, iso3c , .keep_all = TRUE)

## correct names
df_Base_Y<-janitor::clean_names(df_Base_Y)

# Create base at month level
## set list of countries
Countries<-as.data.frame(unique(df_Base_Y$country))
names(Countries)[1] <- "country"
Countries$Dummy<-1
## assign ISO3C
Countries$iso3c <- countrycode(Countries$country, "country.name", "iso3c")
## set list of months
Date<-as.data.frame(seq(as.Date("1980-1-1"), as.Date("2021-12-31"), by = "month"))
names(Date)[1] <- "Date.month"
Date$Dummy<-1
Date$Date.month<-as.yearmon(Date$Date.month)
## create base
df_Base_YM<-left_join(Countries,Date)
## drop dummy
List<-c("Dummy")
df_Base_YM<-drop_columns(df_Base_YM,List)
## create year variable
df_Base_YM$year <- as.integer(c((substr(( c(df_Base_YM$Date.month)), 5, 8))))

## correct names
df_Base_YM<-janitor::clean_names(df_Base_YM)

```

### Natural resource revenues - and some more control variables from WB dataset

#### Set subfolder name
```{r}
sub_folder_name<-"WorldBank"
```

#### Create folder
```{r}

# Combine the desktop path with the folder name
folder_path <- file.path(desktop_path, main_folder_name, sub_folder_name)

# Check if the folder exists
if (!file.exists(folder_path)) {
  # If the folder doesn't exist, create it
  dir.create(folder_path)
  cat("Folder", main_folder_name, "created on the desktop.\n")
} else {
  # If the folder already exists, do nothing
  cat("Folder", main_folder_name, "already exists on the desktop.\n")
}
```

#### Importing WB dataset via API
```{r}
library(WDI)

WorldBank <- WDI(
  country = "all",
  indicator = c("Nat_rents"="NY.GDP.TOTL.RT.ZS",
                "oil_rents"="NY.GDP.PETR.RT.ZS",
                "gas_rents"="NY.GDP.NGAS.RT.ZS",
                "minerals_rents"="NY.GDP.MINR.RT.ZS",
                "GDP"="NY.GDP.MKTP.CD",
                "GDP_per_cap_PPP"="NY.GDP.PCAP.PP.KD",
                "GDP_grwt"="NY.GDP.MKTP.KD.ZG",
                "Inflation"="FP.CPI.TOTL.ZG",
                "Service_VA"="NV.SRV.TOTL.ZS",
                "Manuf_VA"="NV.IND.MANF.ZS",
                "Industry_VA"="NV.IND.TOTL.ZS",
                "Agricolture_VA"="NV.AGR.TOTL.ZS",
                "Pop_0_14"="SP.POP.0014.TO.ZS",
                "Pop_tot"="SP.POP.TOTL",
                "Pop_15_64"="SP.POP.1564.TO.ZS",
                "Age_dep_ratio"="SP.POP.DPND",
                "Age_dep_ratio_old"="SP.POP.DPND.OL",
                "Age_dep_ratio_young"="SP.POP.DPND.YG",
                "Inf_mort_rate"="SP.DYN.IMRT.IN",
                "Military_exp_pct_GDP"="MS.MIL.XPND.GD.ZS",
                "Military_exp_pct_Gov_exp"="MS.MIL.XPND.ZS",
                "Trade"="NE.TRD.GNFS.ZS",
                "Export_wb"="NE.EXP.GNFS.ZS",
                "Import_wb"="NE.IMP.GNFS.ZS",
                "FDI"="BX.KLT.DINV.WD.GD.ZS",
                "FDI_out"="BX.KLT.DINV.WD.GD.ZS",
                "Food_export"="TX.VAL.FOOD.ZS.UN",
                "Food_import"="TM.VAL.FOOD.ZS.UN",
                "Urb_pop_pct"="SP.URB.TOTL.IN.ZS",
                "Urb_pop_grw_pct"="SP.URB.GROW",
                "Rural_pop_grw_pct"="SP.RUR.TOTL.ZG",
                "Rural_pop_pct"="SP.RUR.TOTL.ZS",
                "Remittances_pct_GDP"="BX.TRF.PWKR.DT.GD.ZS",
                "Cereal_prod"="AG.PRD.CREL.MT"
  ),
  start = 1980,
  end = 2020,
  extra = TRUE,
  cache = NULL,
  latest = NULL,
  language = "en"
)
```

#### Setting path to save DF
```{r}
#saving it
namefile<-"WorldBank.rds"
folder_path_wb <- file.path(desktop_path, main_folder_name, sub_folder_name, namefile)
```

#### Saving DF
```{r}
saveRDS(WorldBank, folder_path_wb)
```

#### Importing DF from folder
```{r}
#importing wb df
df_WorldBank <- readRDS(folder_path_wb)

## assign ISO3
names(df_WorldBank)[names(df_WorldBank) == "country"] <- "country_wb"
df_WorldBank$iso3c <- countrycode(df_WorldBank$country_wb, "country.name", "iso3c")

#drop iso3c NAs
df_WorldBank<-Drop_NA(df_WorldBank, iso3c)

#sort dataframe
df_WorldBank<-df_WorldBank[
  with(df_WorldBank, order(iso3c, year)),
]


## clean 
df_WorldBank <- df_WorldBank[ , ! names(df_WorldBank) %in% c("capital",
                                                             "longitude",
                                                             "latitude",
                                                             "income", 
                                                             "lending",
                                                             "iso2c")]

#list variables aiddata sectoral
List<- colnames(df_WorldBank)[!colnames(df_WorldBank) %in% c("iso3c",
                                                             "year",
                                                             "region")]

## lag variables of 1 to 2 years
df_WorldBank<-Lag_12(df_WorldBank, iso3c, List)

#correct names
df_WorldBank<-janitor::clean_names(df_WorldBank)

```


### Humanitarian organizations
#### Import dataset form folder 
```{r}
HOD_Dec_2021 <- read_dta("HOD_Dec_2021.dta")
df_HOD_Dec_2021<-HOD_Dec_2021
```

#### reshape dataset
```{r}
## assign iso3c
df_HOD_Dec_2021$iso3c <- countrycode(df_HOD_Dec_2021$COUNTHQ, "cown", "iso3c")
## drop if iso3c is NA
df_HOD_Dec_2021<-Drop_NA(df_HOD_Dec_2021, iso3c)
##assign country name
df_HOD_Dec_2021$c_name<- countrycode(df_HOD_Dec_2021$COUNTHQ, "cown", "country.name")


# keep vars of interest
df_HOD_Dec_2021 <- df_HOD_Dec_2021[c("COUNTHQ",
                                       "iso3c",
                                       "c_name",
                                       "name",
                                       "year")]

# reshape to country panel
## create fake end date to 2021
df_HOD_Dec_2021$end_date<-2021
## drop if year is NA
df_HOD_Dec_2021<-Drop_NA(df_HOD_Dec_2021, year)

## Create date variables
df_HOD_Dec_2021$Date.start <- as.Date(paste0(df_HOD_Dec_2021$year, "-", "01", "-01"))
df_HOD_Dec_2021$Date.end <- as.Date(paste0(df_HOD_Dec_2021$end_date, "-", "01", "-01"))


## reshape
# Reshape dataset
df_HOD_Dec_2021_long <- df_HOD_Dec_2021 %>%
  group_by(iso3c, name) %>%
  summarise(date = list(seq(floor_date(min(Date.start), unit = "year"),
                            floor_date(max(Date.end), unit = "year"),
                            by = "year"))) %>%
  unnest(cols = c(date))

# Create variable year
df_HOD_Dec_2021_long$year <- as.double(substr(df_HOD_Dec_2021_long$date, 1, 4))

# collapse to country year and count number of organizations per country
## create dummy for count
df_HOD_Dec_2021_long$count <- 1
## collapse dataset
df_HOD_cy <- df_HOD_Dec_2021_long %>%
  group_by(iso3c, year) %>%
  summarise(count_HO = sum(count))

# create lags
List<-c("count_HO")
df_HOD_cy <- Lag_12(df_HOD_cy, iso3c, List)


## subset years of interest
df_HOD_cy<-subset(df_HOD_cy, df_HOD_cy$year>1980)

```


### Trade partners
#### Set subfolder name
```{r}
sub_folder_name<-"UN Comtrade"
```

#### Create folder
```{r}

# Combine the desktop path with the folder name
folder_path <- file.path(desktop_path, main_folder_name, sub_folder_name)

# Check if the folder exists
if (!file.exists(folder_path)) {
  # If the folder doesn't exist, create it
  dir.create(folder_path)
  cat("Folder", main_folder_name, "created on the desktop.\n")
} else {
  # If the folder already exists, do nothing
  cat("Folder", main_folder_name, "already exists on the desktop.\n")
}
```
#### manually add to the folder the single csv files from the cloud


#### import and compose dataset
```{r}

## set path
file_path<-file.path(desktop_path,main_folder_name, sub_folder_name, "TradeData_")

#import datasets
ldf <- list() # creates a list

for (k in 1994:2021){

 year<-paste0("",k,"")
 File<-paste0(file_path,year,".csv")
 df<- read.csv(File, header = TRUE, quote = "")
 ldf[[k]]<-df

}

#bind datasets
df_UNcomtrade <- do.call(rbind, ldf)
# drop list
rm(ldf)

#saving it
namefile<-"df_UNcomtrade.rds"
folder_path_UNcom <- file.path(desktop_path,main_folder_name, sub_folder_name, namefile)
saveRDS(df_UNcomtrade, folder_path_UNcom)

```


#### clean and reshape
##### import from main folder
```{r}
#importing wb df
df_UNcomtrade <- readRDS(folder_path_UNcom)

```

##### Count number of export partners for each country
```{r}
## subset export partners
df_UNcomtrade_export<-subset(df_UNcomtrade, df_UNcomtrade$FlowCode=="X")

# collapse dataset
df_UNcomtrade_export <- df_UNcomtrade_export %>%
    group_by(ReporterISO, RefYear) %>%
    summarise(exp_part = n_distinct(PartnerCode))

# left join with base year
df_UNcomtrade_export <- left_join(df_Base_Y, df_UNcomtrade_export, by = c("year" = "RefYear", "iso3c" = "ReporterISO"))

## subset years for which we have data
df_UNcomtrade_export<-subset(df_UNcomtrade_export, df_UNcomtrade_export$year>1993)


```

##### Count number of import partners for each country
```{r}
## subset export partners
df_UNcomtrade_import<-subset(df_UNcomtrade, df_UNcomtrade$FlowCode=="M")

# collapse dataset
df_UNcomtrade_import <- df_UNcomtrade_import %>%
    group_by(ReporterISO, RefYear) %>%
    summarise(impo_part = n_distinct(PartnerCode))

# left join with base year
df_UNcomtrade_import <- left_join(df_Base_Y, df_UNcomtrade_import, by = c("year" = "RefYear", "iso3c" = "ReporterISO"))

## subset years for which we have data
df_UNcomtrade_import<-subset(df_UNcomtrade_import, df_UNcomtrade_import$year>1993)

```

##### Count number of trade partners for each country
```{r}

# collapse dataset
df_UNcomtrade_imp_exp <- df_UNcomtrade %>%
    group_by(ReporterISO, RefYear) %>%
    summarise(trade_part = n_distinct(PartnerCode))

# left join with base year
df_UNcomtrade_imp_exp <- left_join(df_Base_Y, df_UNcomtrade_imp_exp, by = c("year" = "RefYear", "iso3c" = "ReporterISO"))

## subset years for which we have data
df_UNcomtrade_imp_exp<-subset(df_UNcomtrade_imp_exp, df_UNcomtrade_imp_exp$year>1993)

```

##### Combine export and import
```{r}
# left join dfs
df_UNcomtrade_main <- left_join(df_UNcomtrade_export, df_UNcomtrade_import, by = c("year" = "year","country" = "country", "iso3c" = "iso3c"))
df_UNcomtrade_main <- left_join(df_UNcomtrade_main, df_UNcomtrade_imp_exp, by = c("year" = "year","country" = "country", "iso3c" = "iso3c"))

#list variables aiddata sectoral
List<- colnames(df_UNcomtrade_main)[!colnames(df_UNcomtrade_main) %in% c("iso3c",
                                                             "year",
                                                             "country")]

## lag variables of 1 to 2 years
df_UNcomtrade_main<-Lag_12(df_UNcomtrade_main, iso3c, List)

```


# Merge datasets main independent and controls
```{r}
## add world bank variables
df_Ind_var <- left_join(df_UNcomtrade_main, df_WorldBank, by = c("year" = "year", "iso3c" = "iso3c"))
## add humanitarian dfs
df_Ind_var <- left_join(df_Ind_var, df_HOD_cy, by = c("year" = "year", "iso3c" = "iso3c"))

```

# Export
## Set subfolder name
```{r}
sub_folder_name<-"Compiled"
```

## Create folder
```{r}

# Combine the desktop path with the folder name
folder_path <- file.path(desktop_path, main_folder_name, sub_folder_name)

# Check if the folder exists
if (!file.exists(folder_path)) {
  # If the folder doesn't exist, create it
  dir.create(folder_path)
  cat("Folder", main_folder_name, "created on the desktop.\n")
} else {
  # If the folder already exists, do nothing
  cat("Folder", main_folder_name, "already exists on the desktop.\n")
}
```

## Export file
```{r}
#saving it
namefile<-"df_Ind_var.rds"
folder_path_wb <- file.path(desktop_path, main_folder_name, sub_folder_name, namefile)
saveRDS(df_Ind_var, folder_path_wb)

```


# Exit
```{r}

```










