---
title: "main_independent_variables"
author: "MNB"
date: "4/18/2024"
output: html_document
---


## Libraries
```{r}
library(Hmisc)
library(data.table)

library(R.utils)
library(plyr)
library(dplyr)
library(tidyverse)
library(tidyr)
library(naniar)
library(geosphere)
library(zoo)
library(stringr)
library(tidytext)
library(rworldmap)
library(gridExtra)


library(classInt)
library("ggplot2")
library(devtools)
library(DT)
library(dvmisc)
library(ggpubr)
library(gtools)
library(foreign)
library(maps)


library(spdep)
library(lubridate)


library(WDI)
library(readxl)
library(haven)


library(reshape)

library(geojsonio)

library(countrycode)

library(roll)
```

# Remove lists 
```{r, include=FALSE}
## remove lists
rm(list=ls())
```

# Funtions 
```{r}
# calculate mode
mode <- function(v) {
  uniqv <- unique(v)
  uniqv[which.max(tabulate(match(v, uniqv)))]
}


# exclude
'%!in%' <- function(x,y)!('%in%'(x,y))

drop_columns <- function(data, columns_to_drop) {
  data <- data[, names(data) %!in% columns_to_drop, drop = FALSE]
  return(data)
}


## drop NAs from column
Drop_NA <- function(dataset, col_name){
  col_name <- enquo(col_name)
  dataset %>%
    drop_na((!!col_name)) %>%
    as.data.frame()
}

## create 1 and 2 period lags (grouping by a variable)
Lag_12 <- function(dataset,col_name,x){
  {
    col_name <- enquo(col_name)
    dataset %>%
      group_by(!!col_name) %>%
      mutate(across(all_of(x),
                    .fns = ~ lag(.,1),
                    .names = paste0("{.col}_lag_",1)))%>%
      mutate(across(all_of(x),
                    .fns = ~ lag(.,2),
                    .names = paste0("{.col}_lag_",2)))
    
  } 
}

## create 1 and 2 period lags 
Lag_12_ngby <- function(dataset,x){
  {
    dataset %>%
      mutate(across(all_of(x),
                    .fns = ~ lag(.,1),
                    .names = paste0("{.col}_lag_",1)))%>%
      mutate(across(all_of(x),
                    .fns = ~ lag(.,2),
                    .names = paste0("{.col}_lag_",2)))
    
  } 
}

## assign 0 to NAs
Nas_to_0 <- function(dataset, x) {
  
  dataset %>% mutate_at(all_of(x), ~replace(., is.na(.), 0))
  
}


download_and_create_folder <- function(file_name, desktop_path, folder_name, url) {
  
  # Combine the desktop path with the folder name
  folder_path <- file.path(desktop_path,main_folder_name, folder_name)
  
  
  # Check if the folder exists
  if (!file.exists(folder_path)) {
    # If the folder doesn't exist, create it
    dir.create(folder_path)
    cat("Folder", folder_path, "created.\n")
  } else {
    # If the folder already exists, do nothing
    cat("Folder", folder_path, "already exists.\n")
  }
  
  # Specify the file path where you want to save the downloaded file
  file_path <- paste0(folder_path, "/", file_name)
  
  # Download the file
  download.file(url, file_path, mode = "wb")
}




download_create_folder_and_unzip <- function(desktop_path, folder_name, url) {
  
  # Combine the desktop path with the folder name
  folder_path <- file.path(desktop_path,main_folder_name, folder_name)
  
  
  # Check if the folder exists
  if (!file.exists(folder_path)) {
    # If the folder doesn't exist, create it
    dir.create(folder_path)
    cat("Folder", folder_path, "created.\n")
  } else {
    # If the folder already exists, do nothing
    cat("Folder", folder_path, "already exists.\n")
  }
  
  # Specify the file path where you want to save the downloaded file
  file_path <- folder_path
  
  # Download the file
  download.file(url, destfile = "temp.zip", mode = "wb")
  
  # Unzip the downloaded file
  unzip("temp.zip", exdir = file_path)
  
  # Delete the temporary zip file
  file.remove("temp.zip")
}

```



# Setting directory for datasets' folders
```{r}
desktop_path <- file.path("C:", "Users", "marco", "Desktop")
#desktop_path <- file.path("C:", "Users","krogers","Documents")
```


# Set main folder name
```{r}
# Define the name of the folder to check/create
main_folder_name <- "DFGlobalLab"
#main_folder_name <- "data"
```

# Creating folder for datasets
```{r}

# Combine the desktop path with the folder name
folder_path <- file.path(desktop_path, main_folder_name)

# Check if the folder exists
if (!file.exists(folder_path)) {
  # If the folder doesn't exist, create it
  dir.create(folder_path)
  cat("Folder", main_folder_name, "created on the desktop.\n")
} else {
  # If the folder already exists, do nothing
  cat("Folder", main_folder_name, "already exists on the desktop.\n")
}
```

# Importing and reshaping Dfs

### Polity 2
#### Set subfolder name
```{r}
sub_folder_name<-"polity2"
```

#### Create folder and download
```{r}
download_and_create_folder("p5v2018.xls",
                           desktop_path,
                           sub_folder_name,
                           "http://www.systemicpeace.org/inscr/p5v2018.xls")
```

#### Import
```{r}
file_path<-file.path(desktop_path,main_folder_name, sub_folder_name, "p5v2018.xls")
## import  dataset
Polity2<- read_excel(file_path)
```

# Create bases - at year and month levels
```{r}
df_Polity2<-Polity2

# Create base at year level
## subset years of interests
df_Polity2<-subset(df_Polity2, df_Polity2$year>1980 & Polity2$year<2020)

# Rename countries
  replacements <- c(
    "Czechoslovakia" = "Czech Republic (the)",
    "Serbia Montenegro" = "Serbia",
    "Yugoslavia" = "Serbia"
  )
  df_Polity2$country <- ifelse(df_Polity2$country %in% names(replacements), replacements[df_Polity2$country], df_Polity2$country)

## assign ISO3C
df_Polity2$iso3c <- countrycode(df_Polity2$country, "country.name", "iso3c")

## subset only columns of interest
df_Base_Y<-df_Polity2[c("country",
                        "iso3c",
                        "year")]

# Complete panel
df_Base_Y<-df_Base_Y %>%
  complete(iso3c,year=c(1981:2021)) %>%
  group_by(iso3c) %>% fill(country) %>%
  ungroup()

## drop iso3c NA
df_Base_Y<-Drop_NA(df_Base_Y, iso3c)

#drop duplicates (usual yuogoslavia and soviet union "problem" with name change to serbia and russia)
df_Base_Y<-df_Base_Y %>% 
                distinct(year, iso3c , .keep_all = TRUE)

## correct names
df_Base_Y<-janitor::clean_names(df_Base_Y)

# Create base at month level
## set list of countries
Countries<-as.data.frame(unique(df_Base_Y$country))
names(Countries)[1] <- "country"
Countries$Dummy<-1
## assign ISO3C
Countries$iso3c <- countrycode(Countries$country, "country.name", "iso3c")
## set list of months
Date<-as.data.frame(seq(as.Date("1980-1-1"), as.Date("2021-12-31"), by = "month"))
names(Date)[1] <- "Date.month"
Date$Dummy<-1
Date$Date.month<-as.yearmon(Date$Date.month)
## create base
df_Base_YM<-left_join(Countries,Date)
## drop dummy
List<-c("Dummy")
df_Base_YM<-drop_columns(df_Base_YM,List)
## create year variable
df_Base_YM$year <- as.integer(c((substr(( c(df_Base_YM$Date.month)), 5, 8))))

## correct names
df_Base_YM<-janitor::clean_names(df_Base_YM)

```



### Natural resource revenues - and some more control variables from WB dataset


#### Set subfolder name
```{r}
sub_folder_name<-"WorldBank"
```

#### Create folder
```{r}

# Combine the desktop path with the folder name
folder_path <- file.path(desktop_path, main_folder_name, sub_folder_name)

# Check if the folder exists
if (!file.exists(folder_path)) {
  # If the folder doesn't exist, create it
  dir.create(folder_path)
  cat("Folder", main_folder_name, "created on the desktop.\n")
} else {
  # If the folder already exists, do nothing
  cat("Folder", main_folder_name, "already exists on the desktop.\n")
}
```

#### WB: importing dataset via API
```{r}

# WorldBank <- WDI(
#   country = "all",
#   indicator = c("Nat_rents"="NY.GDP.TOTL.RT.ZS",
#                 "oil_rents"="NY.GDP.PETR.RT.ZS",
#                 "gas_rents"="NY.GDP.NGAS.RT.ZS",
#                 "minerals_rents"="NY.GDP.MINR.RT.ZS",
#                 "GDP"="NY.GDP.MKTP.CD",
#                 "GDP_per_cap_PPP"="NY.GDP.PCAP.PP.KD",
#                 "GDP_grwt"="NY.GDP.MKTP.KD.ZG",
#                 "Inflation"="FP.CPI.TOTL.ZG",
#                 "Service_VA"="NV.SRV.TOTL.ZS",
#                 "Manuf_VA"="NV.IND.MANF.ZS",
#                 "Industry_VA"="NV.IND.TOTL.ZS",
#                 "Agricolture_VA"="NV.AGR.TOTL.ZS",
#                 "Pop_0_14"="SP.POP.0014.TO.ZS",
#                 "Pop_tot"="SP.POP.TOTL",
#                 "Pop_15_64"="SP.POP.1564.TO.ZS",
#                 "Age_dep_ratio"="SP.POP.DPND",
#                 "Age_dep_ratio_old"="SP.POP.DPND.OL",
#                 "Age_dep_ratio_young"="SP.POP.DPND.YG",
#                 "Inf_mort_rate"="SP.DYN.IMRT.IN",
#                 "Military_exp_pct_GDP"="MS.MIL.XPND.GD.ZS",
#                 "Military_exp_pct_Gov_exp"="MS.MIL.XPND.ZS",
#                 "Trade"="NE.TRD.GNFS.ZS",
#                 "Export_wb"="NE.EXP.GNFS.ZS",
#                 "Import_wb"="NE.IMP.GNFS.ZS",
#                 "FDI"="BX.KLT.DINV.WD.GD.ZS",
#                 "FDI_out"="BX.KLT.DINV.WD.GD.ZS",
#                 "Food_export"="TX.VAL.FOOD.ZS.UN",
#                 "Food_import"="TM.VAL.FOOD.ZS.UN",
#                 "Urb_pop_pct"="SP.URB.TOTL.IN.ZS",
#                 "Urb_pop_grw_pct"="SP.URB.GROW",
#                 "Rural_pop_grw_pct"="SP.RUR.TOTL.ZG",
#                 "Rural_pop_pct"="SP.RUR.TOTL.ZS",
#                 "Remittances_pct_GDP"="BX.TRF.PWKR.DT.GD.ZS",
#                 "Cereal_prod"="AG.PRD.CREL.MT"
#   ),
#   start = 1980,
#   end = 2020,
#   extra = TRUE,
#   cache = NULL,
#   latest = NULL,
#   language = "en"
# )

```

#### Setting path to save DF
```{r}
#saving it
namefile<-"WorldBank.rds"
folder_path_wb <- file.path(desktop_path, main_folder_name, sub_folder_name, namefile)
```

#### Saving DF
```{r}
# saveRDS(WorldBank, folder_path_wb)
```

#### Importing DF from folder
```{r}
#importing wb df
df_WorldBank <- readRDS(folder_path_wb)

## assign ISO3
names(df_WorldBank)[names(df_WorldBank) == "country"] <- "country_wb"
df_WorldBank$iso3c <- countrycode(df_WorldBank$country_wb, "country.name", "iso3c")

#drop iso3c NAs
df_WorldBank<-Drop_NA(df_WorldBank, iso3c)

#sort dataframe
df_WorldBank<-df_WorldBank[
  with(df_WorldBank, order(iso3c, year)),
]


## clean 
df_WorldBank <- df_WorldBank[ , ! names(df_WorldBank) %in% c("capital",
                                                             "longitude",
                                                             "latitude",
                                                             "income", 
                                                             "lending",
                                                             "iso2c",
                                                             "country_wb")]

#list variables aiddata sectoral
List<- colnames(df_WorldBank)[!colnames(df_WorldBank) %in% c("iso3c",
                                                             "year",
                                                             "region")]

## lag variables of 1 to 2 years
df_WorldBank<-Lag_12(df_WorldBank, iso3c, List)

#correct names
df_WorldBank<-janitor::clean_names(df_WorldBank)

```

### V-Dem dataset for additioal polity controls

#### Set subfolder name
```{r}
sub_folder_name<-"Vdem"
```

#### Create folder
```{r}

# Combine the desktop path with the folder name
folder_path <- file.path(desktop_path, main_folder_name, sub_folder_name)

# Check if the folder exists
if (!file.exists(folder_path)) {
  # If the folder doesn't exist, create it
  dir.create(folder_path)
  cat("Folder", main_folder_name, "created on the desktop.\n")
} else {
  # If the folder already exists, do nothing
  cat("Folder", main_folder_name, "already exists on the desktop.\n")
}
```
#### Add to the folder the videm dataset manually
#### Import dataset
```{r}
namefile<-c("V-Dem-CY-Full+Others-v14.rds")
folder_path <- file.path(desktop_path, main_folder_name, sub_folder_name, namefile)

#import df_Vdem
Vdem<- readRDS(folder_path)
df_Vdem<-Vdem


```

#### Subset variables of interest
```{r}


#subset years
df_Vdem<-subset(df_Vdem, df_Vdem$year>=1980)

#rename columns
names(df_Vdem)[names(df_Vdem) == "country_text_id"] <- "iso3c"
names(df_Vdem)[names(df_Vdem) == "country_name"] <- "country_Vdem"

#subset variables of interests
df_Vdem_s<-df_Vdem[c("iso3c",
                   "year",
                   "v2clstown",
                   "v2xnp_regcorr",
                   "v2x_regime_amb",
                   "v2cacamps",
                   "e_gdp",
                   "e_gdppc",
                   "e_polity2",
                   "v2x_ex_military",
                   "v2dlencmps",
                   "v2svdomaut",
                   "e_regionpol_6C",
                   "v2xcs_ccsi",
                   "v2xnp_client",
                   "v2x_pubcorr",
                   "v2excrptps",
                   "v2exthftps",
                   "v2svstterr",
                   "v2stfisccap",
                   "v2stcritapparm",
                   "v2x_corr",
                   "v2x_execorr",
                   "e_total_fuel_income_pc",
                   "v2x_polyarchy",
                   "v2x_libdem",
                   "v2x_partipdem",
                   "v2x_delibdem",
                   "v2x_egaldem")]


#rename columns
names(df_Vdem_s)[names(df_Vdem_s) == "e_total_fuel_income_pc"] <- "fuel_income"
names(df_Vdem_s)[names(df_Vdem_s) == "v2x_polyarchy"] <- "electoral_demo"
names(df_Vdem_s)[names(df_Vdem_s) == "v2x_libdem"] <- "liberal_demo"
names(df_Vdem_s)[names(df_Vdem_s) == "v2x_partipdem"] <- "part_demo"
names(df_Vdem_s)[names(df_Vdem_s) == "v2x_delibdem"] <- "delib_demo"
names(df_Vdem_s)[names(df_Vdem_s) == "v2x_egaldem"] <- "egal_demo"



names(df_Vdem_s)[names(df_Vdem_s) == "v2clstown"] <- "state_ownership"
names(df_Vdem_s)[names(df_Vdem_s) == "v2xnp_regcorr"] <- "regime_corruption"
names(df_Vdem_s)[names(df_Vdem_s) == "v2x_corr"] <- "political_corr"
names(df_Vdem_s)[names(df_Vdem_s) == "v2x_execorr"] <- "executive_corr"

names(df_Vdem_s)[names(df_Vdem_s) == "v2x_regime_amb"] <- "regime_type"
names(df_Vdem_s)[names(df_Vdem_s) == "v2cacamps"] <- "political_polarization"
names(df_Vdem_s)[names(df_Vdem_s) == "e_gdp"] <- "gdp_vdem"
names(df_Vdem_s)[names(df_Vdem_s) == "e_gdppc"] <- "gdp_pc_vdem"
names(df_Vdem_s)[names(df_Vdem_s) == "e_polity2"] <- "polity2"
names(df_Vdem_s)[names(df_Vdem_s) == "v2x_ex_military"] <- "military_centr"
names(df_Vdem_s)[names(df_Vdem_s) == "v2dlencmps"] <- "spending"
names(df_Vdem_s)[names(df_Vdem_s) == "v2svdomaut"] <- "autonomy"
names(df_Vdem_s)[names(df_Vdem_s) == "e_regionpol_6C"] <- "region_pg"
names(df_Vdem_s)[names(df_Vdem_s) == "v2xcs_ccsi"] <- "civil_soc"

names(df_Vdem_s)[names(df_Vdem_s) == "v2xnp_client"] <- "clientelism_index"
names(df_Vdem_s)[names(df_Vdem_s) == "v2x_pubcorr"] <- "pub_sect_corr_index"
names(df_Vdem_s)[names(df_Vdem_s) == "v2excrptps"] <- "pub_sect_corr_exch"
names(df_Vdem_s)[names(df_Vdem_s) == "v2exthftps"] <- "pub_sect_theft"
names(df_Vdem_s)[names(df_Vdem_s) == "v2svstterr"] <- "state_auth_terr"
names(df_Vdem_s)[names(df_Vdem_s) == "v2stfisccap"] <- "revenues_source"
names(df_Vdem_s)[names(df_Vdem_s) == "v2stcritapparm"] <- "appointment_in_ssfs"


#list variables aiddata sectoral
List<- colnames(df_Vdem_s)[!colnames(df_Vdem_s) %in% c("iso3c",
                                                       "year",
                                                       "region")]

                           ## lag variables of 1 to 2 years
df_Vdem_s<-Lag_12(df_Vdem_s, iso3c, List)

#correct names
df_Vdem_s<-janitor::clean_names(df_Vdem_s)

```

### Number of IGOs a country is member of
### https://correlatesofwar.org/data-sets/IGOs/
#### Set name folder
```{r}
sub_folder_name<-"IGOs"
```
#### Create folder and download
```{r}
download_create_folder_and_unzip(desktop_path,
                           sub_folder_name,
                           "https://correlatesofwar.org/wp-content/uploads/state_year_formatv3.zip")
```

#### Import
```{r}
file_path<-file.path(desktop_path,main_folder_name, sub_folder_name, "state_year_formatv3.csv")
## import  dataset
df_IGOs<- read.csv(file_path)
```

#### Organize data
```{r}
## subset years greater than 1989
df_IGOs<-subset(df_IGOs, df_IGOs$year>1988)
## assign iso3ccode
df_IGOs$iso3c <- countrycode(df_IGOs$ccode, "cown", "iso3c")

## count 1 and 2 across columns
### create list of vars to count
List<- colnames(df_IGOs)[colnames(df_IGOs) %!in% c("iso3c", "year", "ccode", "country","state")]
### count memberships
df_IGOs <- df_IGOs %>%
  rowwise() %>%
  mutate(
    N_memberships = sum(c_across(all_of(List)) %in% c(1, 2))
  ) %>%
  ungroup()

# keep vars of interest
df_IGOs <- df_IGOs[c("iso3c",
                     "year",
                     "N_memberships")]

# create lags
List<-c("N_memberships")
df_IGOs <- Lag_12(df_IGOs, iso3c, List)
```


### Humanitarian organizations
#### Import dataset form folder 
```{r}
HOD_Dec_2021 <- read_dta("HOD_Dec_2021.dta")
df_HOD_Dec_2021<-HOD_Dec_2021
```

#### reshape dataset
```{r}
## assign iso3c
df_HOD_Dec_2021$iso3c <- countrycode(df_HOD_Dec_2021$COUNTHQ, "cown", "iso3c")
## drop if iso3c is NA
df_HOD_Dec_2021<-Drop_NA(df_HOD_Dec_2021, iso3c)
##assign country name
df_HOD_Dec_2021$c_name<- countrycode(df_HOD_Dec_2021$COUNTHQ, "cown", "country.name")


# keep vars of interest
df_HOD_Dec_2021 <- df_HOD_Dec_2021[c("COUNTHQ",
                                       "iso3c",
                                       "c_name",
                                       "name",
                                       "year")]

# reshape to country panel
## create fake end date to 2021
df_HOD_Dec_2021$end_date<-2021
## drop if year is NA
df_HOD_Dec_2021<-Drop_NA(df_HOD_Dec_2021, year)

## Create date variables
df_HOD_Dec_2021$Date.start <- as.Date(paste0(df_HOD_Dec_2021$year, "-", "01", "-01"))
df_HOD_Dec_2021$Date.end <- as.Date(paste0(df_HOD_Dec_2021$end_date, "-", "01", "-01"))


## reshape
# Reshape dataset
df_HOD_Dec_2021_long <- df_HOD_Dec_2021 %>%
  group_by(iso3c, name) %>%
  summarise(date = list(seq(floor_date(min(Date.start), unit = "year"),
                            floor_date(max(Date.end), unit = "year"),
                            by = "year"))) %>%
  unnest(cols = c(date))

# Create variable year
df_HOD_Dec_2021_long$year <- as.double(substr(df_HOD_Dec_2021_long$date, 1, 4))

# collapse to country year and count number of organizations per country
## create dummy for count
df_HOD_Dec_2021_long$count <- 1
## collapse dataset
df_HOD_cy <- df_HOD_Dec_2021_long %>%
  group_by(iso3c, year) %>%
  summarise(count_HO = sum(count))

# create lags
List<-c("count_HO")
df_HOD_cy <- Lag_12(df_HOD_cy, iso3c, List)


## subset years of interest
df_HOD_cy<-subset(df_HOD_cy, df_HOD_cy$year>1980)

```

### Conflict activity (UCDP GED)
#### Link df: https://ucdp.uu.se/downloads/index.html#ged_global
#### Set subfldder name
```{r}
sub_folder_name<-"UCDP"
```

#### Create folder and download
```{r}
download_create_folder_and_unzip(desktop_path,
                           sub_folder_name,
                           "https://ucdp.uu.se/downloads/ged/ged231-csv.zip")
```

#### Import
```{r}
file_path<-file.path(desktop_path,main_folder_name, sub_folder_name, "GEDEvent_v23_1.csv")
#file_path<-file.path("~/Documents/data/UCDP/GEDEvent_v23_1.csv")
## import  dataset
UCDP_GED<- read.csv(file_path)
```


#### Reshaping UCDP GED
##### Adjusting names of countries, setting variables etc.
```{r}
df_UCDP_GED<-UCDP_GED

#assign ISO3
df_UCDP_GED$iso3c <- countrycode(df_UCDP_GED$country, "country.name", "iso3c",
                                 custom_match = c("Yemen (North Yemen)" = "YEM"))

#create year month date
            df_UCDP_GED$month <- c((substr(( c(df_UCDP_GED$date_start)), 6, 7)))
            df_UCDP_GED$day<- c((substr(( c(df_UCDP_GED$date_start)), 9, 10)))

            df_UCDP_GED$day.month.year <- as.character(paste0(df_UCDP_GED$month,
                                                          "/",
                                                          df_UCDP_GED$day,
                                                          "/",
                                                          df_UCDP_GED$year))

            df_UCDP_GED$month.year <- as.character(paste0(df_UCDP_GED$year,
                                                      "-",
                                                      df_UCDP_GED$month))

            df_UCDP_GED$Date<-as.Date(df_UCDP_GED$day.month.year, format = "%m/%d/%Y")
            df_UCDP_GED$date_month<-as.yearmon(df_UCDP_GED$month.year)
```

##### Getting it in a country-year panel format
```{r}

df_UCDP_GED_s<-df_UCDP_GED[c("iso3c",
                   "year",
                   "type_of_violence",
                   "best")]


## aggregate at country iso3c level
df_UCDP_GED_Y <- df_UCDP_GED_s %>%
  group_by(iso3c, year, type_of_violence) %>%
  summarize(n_fatalities = sum(best, na.rm = TRUE))

#reshape
df_UCDP_GED_Y<-reshape2::dcast(df_UCDP_GED_Y, year+iso3c~`type_of_violence`)

## merge with Base
df_UCDP_GED_Y= left_join(df_Base_Y, df_UCDP_GED_Y, by = c("year" = "year", "iso3c" = "iso3c"))

## keep only years after 1990
df_UCDP_GED_Y<-subset(df_UCDP_GED_Y,df_UCDP_GED_Y$year>=1990)

#list variables ged
List<- colnames(df_UCDP_GED_Y)[colnames(df_UCDP_GED_Y) %!in% c("iso3c", "year")]

# assign 0s
df_UCDP_GED_Y<-Nas_to_0(df_UCDP_GED_Y,List)

#rename variables
names(df_UCDP_GED_Y)[names(df_UCDP_GED_Y) == "1"] <- "StateBased_conf_fat"
names(df_UCDP_GED_Y)[names(df_UCDP_GED_Y) == "2"] <- "NonState_conf_fat"
names(df_UCDP_GED_Y)[names(df_UCDP_GED_Y) == "3"] <- "OneSided_fat"


## full fatalities
df_UCDP_GED_Y$best_fat<-df_UCDP_GED_Y$StateBased_conf_fat+df_UCDP_GED_Y$NonState_conf_fat+df_UCDP_GED_Y$OneSided_fat

#list variables ged
List<- colnames(df_UCDP_GED_Y)[colnames(df_UCDP_GED_Y) %!in% c("iso3c", "year")]

## create lags
df_UCDP_GED_Y<-Lag_12(df_UCDP_GED_Y, iso3c, List)

```

### Trade partners
#### Set subfolder name
```{r}
sub_folder_name<-"UN Comtrade"
```

#### Create folder
```{r}

# Combine the desktop path with the folder name
folder_path <- file.path(desktop_path, main_folder_name, sub_folder_name)

# Check if the folder exists
if (!file.exists(folder_path)) {
  # If the folder doesn't exist, create it
  dir.create(folder_path)
  cat("Folder", main_folder_name, "created on the desktop.\n")
} else {
  # If the folder already exists, do nothing
  cat("Folder", main_folder_name, "already exists on the desktop.\n")
}
```
#### manually add to the folder the single csv files from the cloud


#### import and compose dataset
```{r}

## set path
file_path<-file.path(desktop_path,main_folder_name, sub_folder_name, "TradeData_")

#import datasets
ldf <- list() # creates a list

for (k in 1994:2021){

 year<-paste0("",k,"")
 File<-paste0(file_path,year,".csv")
 df<- read.csv(File, header = TRUE, quote = "")
 ldf[[k]]<-df

}

#bind datasets
df_UNcomtrade <- do.call(rbind, ldf)
# drop list
rm(ldf)

#saving it
namefile<-"df_UNcomtrade.rds"
folder_path_UNcom <- file.path(desktop_path,main_folder_name, sub_folder_name, namefile)
saveRDS(df_UNcomtrade, folder_path_UNcom)

```


#### clean and reshape
##### import from main folder
```{r}
#importing wb df
df_UNcomtrade <- readRDS(folder_path_UNcom)

```

##### Count number of export partners for each country
```{r}
## subset export partners
df_UNcomtrade_export<-subset(df_UNcomtrade, df_UNcomtrade$FlowCode=="X")

# collapse dataset
df_UNcomtrade_export <- df_UNcomtrade_export %>%
    group_by(ReporterISO, RefYear) %>%
    summarise(exp_part = n_distinct(PartnerCode))

# left join with base year
df_UNcomtrade_export <- left_join(df_Base_Y, df_UNcomtrade_export, by = c("year" = "RefYear", "iso3c" = "ReporterISO"))

## subset years for which we have data
df_UNcomtrade_export<-subset(df_UNcomtrade_export, df_UNcomtrade_export$year>1993)


```

##### Count number of import partners for each country
```{r}
## subset export partners
df_UNcomtrade_import<-subset(df_UNcomtrade, df_UNcomtrade$FlowCode=="M")

# collapse dataset
df_UNcomtrade_import <- df_UNcomtrade_import %>%
    group_by(ReporterISO, RefYear) %>%
    summarise(impo_part = n_distinct(PartnerCode))

# left join with base year
df_UNcomtrade_import <- left_join(df_Base_Y, df_UNcomtrade_import, by = c("year" = "RefYear", "iso3c" = "ReporterISO"))

## subset years for which we have data
df_UNcomtrade_import<-subset(df_UNcomtrade_import, df_UNcomtrade_import$year>1993)

```

##### Count number of trade partners for each country
```{r}

# collapse dataset
df_UNcomtrade_imp_exp <- df_UNcomtrade %>%
    group_by(ReporterISO, RefYear) %>%
    summarise(trade_part = n_distinct(PartnerCode))

# left join with base year
df_UNcomtrade_imp_exp <- left_join(df_Base_Y, df_UNcomtrade_imp_exp, by = c("year" = "RefYear", "iso3c" = "ReporterISO"))

## subset years for which we have data
df_UNcomtrade_imp_exp<-subset(df_UNcomtrade_imp_exp, df_UNcomtrade_imp_exp$year>1993)

```

##### Combine export and import
```{r}
# left join dfs
df_UNcomtrade_main <- left_join(df_UNcomtrade_export, df_UNcomtrade_import, by = c("year" = "year","country" = "country", "iso3c" = "iso3c"))
df_UNcomtrade_main <- left_join(df_UNcomtrade_main, df_UNcomtrade_imp_exp, by = c("year" = "year","country" = "country", "iso3c" = "iso3c"))

#list variables aiddata sectoral
List<- colnames(df_UNcomtrade_main)[!colnames(df_UNcomtrade_main) %in% c("iso3c",
                                                             "year",
                                                             "country")]

## lag variables of 1 to 2 years
df_UNcomtrade_main<-Lag_12(df_UNcomtrade_main, iso3c, List)

```

## count number of donors per each country
### AidData
#### Link df: https://www.aiddata.org/data/aiddata-core-research-release-level-1-v3-0
#### Create folder and download
#### Set name folder
```{r}
sub_folder_name<-"Aidata"
```
#### Create folder and download
```{r}
download_create_folder_and_unzip(desktop_path,
                           sub_folder_name,
                           "https://github.com/AidData-WM/public_datasets/releases/download/v3.0/AidDataCore_ResearchRelease_Level1_v3.0.zip")
```

#### Import
```{r}
file_path<-file.path(desktop_path,main_folder_name, sub_folder_name, "AidDataCoreDonorRecipientYearPurpose_ResearchRelease_Level1_v3.0.csv")
## import  dataset
Aiddata<- read.csv(file_path)

```

#### prepare dataset
```{r}
df_Aiddata<-Aiddata

#change names
df_Aiddata$recipient[df_Aiddata$recipient=="Yugoslavia"] <- "Serbia"
df_Aiddata$recipient[df_Aiddata$recipient=="Serbia and Montenegro"] <- "Serbia"
df_Aiddata$recipient[df_Aiddata$recipient=="Soviet Union"] <- "Russia"

#assign ISO3
df_Aiddata$iso3c <- countrycode(df_Aiddata$recipient, "country.name", "iso3c")

#drop iso3c NAs
df_Aiddata<-df_Aiddata[!is.na(df_Aiddata$iso3c), ]
```


## count number of donors per country
```{r}
  df_donors<- df_Aiddata %>% 
    group_by(iso3c, year) %>%
    summarize(N_donors = n_distinct(donor))


#list variables aiddata sectoral
List<- c("N_donors")

## lag variables of 1 to 2 years
df_donors<-Lag_12(df_donors, iso3c, List)
```
## colonial heritage


## data on disasters in the country




# Merge datasets main independent and controls
```{r}
## add world bank variables
df_Ind_var <- left_join(df_UNcomtrade_main, df_WorldBank, by = c("year" = "year", "iso3c" = "iso3c"))
## add humanitarian dfs
df_Ind_var <- left_join(df_Ind_var, df_HOD_cy, by = c("year" = "year", "iso3c" = "iso3c"))
## add vdem indexes
df_Ind_var <- left_join(df_Ind_var, df_Vdem_s, by = c("year" = "year", "iso3c" = "iso3c"))
## add conf events
df_Ind_var <- left_join(df_Ind_var, df_UCDP_GED_Y, by = c("year" = "year", "iso3c" = "iso3c","country" = "country"))
## add membership
df_Ind_var <- left_join(df_Ind_var, df_IGOs, by = c("year" = "year", "iso3c" = "iso3c"))
## add donors
df_Ind_var <- left_join(df_Ind_var, df_donors, by = c("year" = "year", "iso3c" = "iso3c"))

```

# Export
## Set subfolder name
```{r}
sub_folder_name<-"Compiled"
```

## Create folder
```{r}

# Combine the desktop path with the folder name
folder_path <- file.path(desktop_path, main_folder_name, sub_folder_name)

# Check if the folder exists
if (!file.exists(folder_path)) {
  # If the folder doesn't exist, create it
  dir.create(folder_path)
  cat("Folder", main_folder_name, "created on the desktop.\n")
} else {
  # If the folder already exists, do nothing
  cat("Folder", main_folder_name, "already exists on the desktop.\n")
}
```

## Export file
```{r}
#saving it
namefile<-"df_Ind_var.rds"
folder_path_wb <- file.path(desktop_path, main_folder_name, sub_folder_name, namefile)
saveRDS(df_Ind_var, folder_path_wb)

```


# Exit
```{r}

```










