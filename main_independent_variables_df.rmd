---
title: "main_independent_variables"
author: "MNB"
date: "4/18/2024"
output: html_document
---

## 01 12 2025
## Libraries
```{r, include=FALSE}
library(Hmisc)
library(data.table)
library(R.utils)
library(plyr)
library(dplyr)
library(tidyverse)
library(tidyr)
library(naniar)
library(geosphere)
library(zoo)
library(stringr)
library(tidytext)
library(gridExtra)
library(classInt)
library(DT)
library(dvmisc)
library(gtools)
library(foreign)
library(lubridate)
library(WDI)
library(readxl)
library(haven)
library(reshape)
library(geojsonio)
library(countrycode)
library(roll)
```

# Remove lists 
```{r, include=FALSE}
## remove lists
rm(list=ls())
```

# Funtions 
```{r, include=FALSE}

# exclude
'%!in%' <- function(x,y)!('%in%'(x,y))

drop_columns <- function(data, columns_to_drop) {
  data <- data[, names(data) %!in% columns_to_drop, drop = FALSE]
  return(data)
}


## drop NAs from column
Drop_NA <- function(dataset, col_name){
  col_name <- enquo(col_name)
  dataset %>%
    drop_na((!!col_name)) %>%
    as.data.frame()
}

## create 1 and 2 period lags (grouping by a variable)
Lag_12 <- function(dataset,col_name,x){
  {
    col_name <- enquo(col_name)
    dataset %>%
      group_by(!!col_name) %>%
      mutate(across(all_of(x),
                    .fns = ~ lag(.,1),
                    .names = paste0("{.col}_lag_",1)))%>%
      mutate(across(all_of(x),
                    .fns = ~ lag(.,2),
                    .names = paste0("{.col}_lag_",2)))
    
  } 
}

## create 1 and 2 period lags 
Lag_12_ngby <- function(dataset,x){
  {
    dataset %>%
      mutate(across(all_of(x),
                    .fns = ~ lag(.,1),
                    .names = paste0("{.col}_lag_",1)))%>%
      mutate(across(all_of(x),
                    .fns = ~ lag(.,2),
                    .names = paste0("{.col}_lag_",2)))
    
  } 
}

## assign 0 to NAs
Nas_to_0 <- function(dataset, x) {
  
  dataset %>% mutate_at(all_of(x), ~replace(., is.na(.), 0))
  
}


download_and_create_folder <- function(file_name, desktop_path, folder_name, url) {
  
  # Combine the desktop path with the folder name
  folder_path <- file.path(desktop_path,main_folder_name, folder_name)
  
  
  # Check if the folder exists
  if (!file.exists(folder_path)) {
    # If the folder doesn't exist, create it
    dir.create(folder_path)
    cat("Folder", folder_path, "created.\n")
  } else {
    # If the folder already exists, do nothing
    cat("Folder", folder_path, "already exists.\n")
  }
  
  # Specify the file path where you want to save the downloaded file
  file_path <- paste0(folder_path, "/", file_name)
  
  # Download the file
  download.file(url, file_path, mode = "wb")
}




download_create_folder_and_unzip <- function(desktop_path, folder_name, url) {
  
  # Combine the desktop path with the folder name
  folder_path <- file.path(desktop_path,main_folder_name, folder_name)
  
  
  # Check if the folder exists
  if (!file.exists(folder_path)) {
    # If the folder doesn't exist, create it
    dir.create(folder_path)
    cat("Folder", folder_path, "created.\n")
  } else {
    # If the folder already exists, do nothing
    cat("Folder", folder_path, "already exists.\n")
  }
  
  # Specify the file path where you want to save the downloaded file
  file_path <- folder_path
  
  # Download the file
  download.file(url, destfile = "temp.zip", mode = "wb")
  
  # Unzip the downloaded file
  unzip("temp.zip", exdir = file_path)
  
  # Delete the temporary zip file
  file.remove("temp.zip")
}


# Define a function to rename specified columns with a given suffix
rename_columns <- function(df, suffix, vars_to_change) {
  # Create new names for the specified variables by adding the suffix
  new_names <- setNames(paste0(vars_to_change, suffix), vars_to_change)
  
  # Rename the columns in the data frame
  names(df)[names(df) %in% names(new_names)] <- new_names[names(df)[names(df) %in% names(new_names)]]
  
  # Return the modified data frame
  return(df)
}
```



# Setting directory for datasets' folders
```{r}
desktop_path <- file.path("C:", "Users", "marco", "Desktop")
#desktop_path <- file.path("C:", "Users","krogers","Documents")
```


# Set main folder name
```{r}
# Define the name of the folder to check/create
main_folder_name <- "DFGlobalLab"
#main_folder_name <- "data"
```

# Creating folder for datasets
```{r}

# Combine the desktop path with the folder name
folder_path <- file.path(desktop_path, main_folder_name)

# Check if the folder exists
if (!file.exists(folder_path)) {
  # If the folder doesn't exist, create it
  dir.create(folder_path)
  cat("Folder", main_folder_name, "created on the desktop.\n")
} else {
  # If the folder already exists, do nothing
  cat("Folder", main_folder_name, "already exists on the desktop.\n")
}
```

# Importing and reshaping Dfs

## Polity 2
#### Set subfolder name
```{r}
sub_folder_name<-"polity2"
```

#### Create folder and download
```{r}
# download_and_create_folder("p5v2018.xls",
#                            desktop_path,
#                            sub_folder_name,
#                            "http://www.systemicpeace.org/inscr/p5v2018.xls")
```

#### Import
```{r}
file_path<-file.path(desktop_path,main_folder_name, sub_folder_name, "p5v2018.xls")
## import  dataset
df_Polity2<- read_excel(file_path)
```

# Create bases - at year level
```{r}

# Create base at year level
## subset years of interests only
df_Polity2<-subset(df_Polity2, df_Polity2$year>1992 & df_Polity2$year<2019)

# Rename countries
  replacements <- c("Yugoslavia" = "Serbia",
                    "Serbia and Montenegro" = "Serbia",
                    "Congo-Brazzaville" = "Congo Brazzaville",
                    "Ivory Coast" = "Cote D'Ivoire")

df_Polity2$country <- ifelse(df_Polity2$country %in% names(replacements), replacements[df_Polity2$country], df_Polity2$country)

## assign ISO3C
df_Polity2$iso3c <- countrycode(df_Polity2$country, "country.name", "iso3c")

## subset only columns of interest
df_Base_Y<-df_Polity2[c("country",
                        "iso3c",
                        "year")]

## drop iso3c NA
df_Base_Y<-Drop_NA(df_Base_Y, iso3c)

#drop duplicates
df_Base_Y<-df_Base_Y %>% 
                distinct(year, iso3c , .keep_all = TRUE)

```

## WB dataset
### Set subfolder name
```{r}
sub_folder_name<-"WorldBank"
```

### Create folder
```{r}

# Combine the desktop path with the folder name
folder_path <- file.path(desktop_path, main_folder_name, sub_folder_name)

# Check if the folder exists
if (!file.exists(folder_path)) {
  # If the folder doesn't exist, create it
  dir.create(folder_path)
  cat("Folder", main_folder_name, "created on the desktop.\n")
} else {
  # If the folder already exists, do nothing
  cat("Folder", main_folder_name, "already exists on the desktop.\n")
}
```

### WB: importing dataset via API
```{r}

# WorldBank <- WDI(
#   country = "all",
#   indicator = c("Nat_rents"="NY.GDP.TOTL.RT.ZS",
#                 "oil_rents"="NY.GDP.PETR.RT.ZS",
#                 "gas_rents"="NY.GDP.NGAS.RT.ZS",
#                 "minerals_rents"="NY.GDP.MINR.RT.ZS",
#                 "GDP"="NY.GDP.MKTP.CD",
#                 "GDP_pc"="NY.GDP.PCAP.CD",
#                 "GDP_per_cap_PPP"="NY.GDP.PCAP.PP.KD",
#                 "Inflation"="FP.CPI.TOTL.ZG",
#                 "Pop_tot"="SP.POP.TOTL",
#                 "Inf_mort_rate"="SP.DYN.IMRT.IN",
#                 "Trade"="NE.TRD.GNFS.ZS",
#                 "Mil_per"="MS.MIL.TOTL.P1",
#                 "lit_rate"="SE.ADT.1524.LT.ZS"
#   ),
#   start = 1993,
#   end = 2020,
#   extra = TRUE,
#   cache = NULL,
#   latest = NULL,
#   language = "en"
# )


```

### Setting path to save DF
```{r}
# setting path to save and import df
namefile<-"WorldBank.rds"
folder_path_wb <- file.path(desktop_path, main_folder_name, sub_folder_name, namefile)
```

### Saving DF
```{r}
#saving it

#saveRDS(WorldBank, folder_path_wb)

```

### Importing DF from folder
```{r}
#importing wb df
df_WorldBank <- readRDS(folder_path_wb)

## assign ISO3
names(df_WorldBank)[names(df_WorldBank) == "country"] <- "country_wb"
df_WorldBank$iso3c <- countrycode(df_WorldBank$country_wb, "country.name", "iso3c")

#drop iso3c NAs
df_WorldBank<-Drop_NA(df_WorldBank, iso3c)

#sort dataframe
df_WorldBank<-df_WorldBank[
  with(df_WorldBank, order(iso3c, year)),
]


## clean 
df_WorldBank <- df_WorldBank[ , ! names(df_WorldBank) %in% c("capital",
                                                             "longitude",
                                                             "latitude",
                                                             "income", 
                                                             "lending",
                                                             "iso2c",
                                                             "country_wb",
                                                             "country")]


# left join with base year
df_WorldBank <- left_join(df_Base_Y, df_WorldBank, by = c("year" = "year", "iso3c" = "iso3c"))
df_WorldBank <- dplyr::select(df_WorldBank, -c(country,status,lastupdated))


#list variables aiddata sectoral
List<- colnames(df_WorldBank)[!colnames(df_WorldBank) %in% c("iso3c",
                                                             "year",
                                                             "region")]

## lag variables of 1 to 2 years
df_WorldBank<-Lag_12(df_WorldBank, iso3c, List)

#correct names
df_WorldBank<-janitor::clean_names(df_WorldBank)

```
### AidData
#### Link df: https://www.aiddata.org/data/aiddata-core-research-release-level-1-v3-0
#### Create folder and download
#### Set name folder
```{r}
sub_folder_name<-"Aidata"
```
#### Create folder and download
```{r}
# download_create_folder_and_unzip(desktop_path,
#                            sub_folder_name,
#                            "https://github.com/AidData-WM/public_datasets/releases/download/v3.0/AidDataCore_ResearchRelease_Level1_v3.0.zip")
```

#### Import
```{r}
file_path<-file.path(desktop_path,main_folder_name, sub_folder_name, "AidDataCoreDonorRecipientYearPurpose_ResearchRelease_Level1_v3.0.csv")
## import  dataset
Aiddata<- read.csv(file_path)
```


#### Reshaping AidData 
##### Calculating total amount of aid
```{r}

df_Aiddata<-Aiddata

#change names
df_Aiddata$recipient[df_Aiddata$recipient=="Yugoslavia"]            <- "Serbia"
df_Aiddata$recipient[df_Aiddata$recipient=="Serbia and Montenegro"] <- "Serbia"
df_Aiddata$recipient[df_Aiddata$recipient=="Soviet Union"]          <- "Russia"

## aggregate at country recipient level
df_Aiddata<- df_Aiddata %>% 
  group_by(recipient, year ) %>%
  summarize(AidData_tot_commit = sum(commitment_amount_usd_constant_sum))

#assign ISO3
df_Aiddata$iso3c <- countrycode(df_Aiddata$recipient, "country.name", "iso3c")

#drop iso3c NAs
df_Aiddata<-df_Aiddata[!is.na(df_Aiddata$iso3c), ]

#create Aiddata country date dataset
df_Aiddata_C<-as.data.frame(unique(df_Aiddata$iso3c))
names(df_Aiddata_C)[1] <- "iso3c"
df_Aiddata_C$Dummy<-1
Date_Y_AidData<-as.data.frame(seq(as.Date("1990-1-1"), as.Date("2013-12-31"), by = "year"))
names(Date_Y_AidData)[1] <- "year"
Date_Y_AidData$Dummy<-1
Date_Y_AidData$year<-as.double((substr(( c(Date_Y_AidData$year)), 1, 4)))
df_Aiddata_CY<-left_join(df_Aiddata_C,Date_Y_AidData)

# merge with with aid data country year vector
df_Aiddata<-left_join(df_Aiddata_CY,df_Aiddata, by = c("iso3c" = "iso3c","year"="year"))

## merge with world Bank Population
WorldBank_pop <- WDI(
  country = "all",
  indicator = c("Pop_tot"="SP.POP.TOTL"),
  start = 1990,
  end = 2020,
  extra = TRUE,
  cache = NULL,
  latest = NULL,
  language = "en"
)

## assign ISO3
names(WorldBank_pop)[names(WorldBank_pop) == "country"] <- "country_wb"
WorldBank_pop$iso3c <- countrycode(WorldBank_pop$country_wb, "country.name", "iso3c")

# merge with aid data 
df_Aiddata<-left_join(df_Aiddata,WorldBank_pop)

##assign 0s and NAs
List<-c("AidData_tot_commit")
df_Aiddata<-Nas_to_0(df_Aiddata, List)

#divide by population
df_Aiddata$AidData_tot_commit_per_cap<-df_Aiddata$AidData_tot_commit/df_Aiddata$Pop_tot

# keep var of interest
df_Aiddata <- df_Aiddata[ , !names(df_Aiddata) %in% c("Dummy",
                                                      "iso2c",
                                                      "country_wb",
                                                      "Pop_tot",
                                                      "region",
                                                      "capital",
                                                      "longitude",
                                                      "latitude",
                                                      "income",
                                                      "lending",
                                                      "recipient")]
## merge with Base
df_Aiddata= left_join(df_Base_Y, df_Aiddata, by = c("year" = "year", "iso3c" = "iso3c"))

#list variables aidata
List<- colnames(df_Aiddata)[!colnames(df_Aiddata) %in% c("iso3c", "year")]

# assign 0s
df_Aiddata<-Nas_to_0(df_Aiddata,List)

# Replace values with NA for years after 2013
df_Aiddata[df_Aiddata$year > 2013, List] <- NA

#rename
df_Aiddata<- df_Aiddata %>% 
  dplyr::rename(commitment_tot = AidData_tot_commit,
         commitment_tot_pc = AidData_tot_commit_per_cap)
            
# list variables aidata
List<- colnames(df_Aiddata)[colnames(df_Aiddata) %in% c("commitment_tot",
                                                        "commitment_tot_pc")]

## lag variables of 1 to 2 years
df_Aiddata<-Lag_12(df_Aiddata, iso3c, List)

```


## V-Dem dataset for additioal polity controls
### Set subfolder name
```{r}
sub_folder_name<-"Vdem"
```

### Create folder
```{r}

# Combine the desktop path with the folder name
folder_path <- file.path(desktop_path, main_folder_name, sub_folder_name)

# Check if the folder exists
if (!file.exists(folder_path)) {
  # If the folder doesn't exist, create it
  dir.create(folder_path)
  cat("Folder", main_folder_name, "created on the desktop.\n")
} else {
  # If the folder already exists, do nothing
  cat("Folder", main_folder_name, "already exists on the desktop.\n")
}
```
### Add to the folder the videm dataset manually
### Import dataset
```{r}
namefile<-c("V-Dem-CY-Full+Others-v14.rds")
folder_path <- file.path(desktop_path, main_folder_name, sub_folder_name, namefile)

#import df_Vdem
df_Vdem<- readRDS(folder_path)

```

### Subset variables of interest
```{r}

#subset years
df_Vdem<-subset(df_Vdem, df_Vdem$year>1989)

#rename columns
names(df_Vdem)[names(df_Vdem) == "country_text_id"] <- "iso3c"
names(df_Vdem)[names(df_Vdem) == "country_name"] <- "country_Vdem"

#subset variables of interests
df_Vdem_s<-df_Vdem[c("iso3c",
                   "year",
                   "v2clstown",
                   "v2xnp_regcorr",
                   "v2x_regime_amb",
                   "v2cacamps",
                   "e_gdp",
                   "e_gdppc",
                   "e_polity2",
                   "v2x_ex_military",
                   "v2dlencmps",
                   "v2svdomaut",
                   "e_regionpol_6C",
                   "v2xcs_ccsi",
                   "v2xnp_client",
                   "v2x_pubcorr",
                   "v2excrptps",
                   "v2exthftps",
                   "v2svstterr",
                   "v2stfisccap",
                   "v2stcritapparm",
                   "v2x_corr",
                   "v2x_execorr",
                   "e_total_fuel_income_pc",
                   "v2x_polyarchy",
                   "v2x_libdem",
                   "v2x_partipdem",
                   "v2x_delibdem",
                   "v2x_egaldem",
                   "v3ststeecap",
                   "v2regdur",
                   "e_regionpol",
                   "e_regiongeo")]


#rename columns
names(df_Vdem_s)[names(df_Vdem_s) == "e_total_fuel_income_pc"] <- "fuel_income"
names(df_Vdem_s)[names(df_Vdem_s) == "v2x_polyarchy"]          <- "electoral_demo"
names(df_Vdem_s)[names(df_Vdem_s) == "v2x_libdem"]             <- "liberal_demo"
names(df_Vdem_s)[names(df_Vdem_s) == "v2x_partipdem"]          <- "part_demo"
names(df_Vdem_s)[names(df_Vdem_s) == "v2x_delibdem"]           <- "delib_demo"
names(df_Vdem_s)[names(df_Vdem_s) == "v2x_egaldem"]            <- "egal_demo"

names(df_Vdem_s)[names(df_Vdem_s) == "v2clstown"]              <- "state_ownership"
names(df_Vdem_s)[names(df_Vdem_s) == "v2xnp_regcorr"]          <- "regime_corruption"
names(df_Vdem_s)[names(df_Vdem_s) == "v2x_corr"]               <- "political_corr"
names(df_Vdem_s)[names(df_Vdem_s) == "v2x_execorr"]            <- "executive_corr"
names(df_Vdem_s)[names(df_Vdem_s) == "v2x_regime_amb"]         <- "regime_type"
names(df_Vdem_s)[names(df_Vdem_s) == "v2cacamps"]              <- "political_polarization"
names(df_Vdem_s)[names(df_Vdem_s) == "e_gdp"]                  <- "gdp_vdem"
names(df_Vdem_s)[names(df_Vdem_s) == "e_gdppc"]                <- "gdp_pc_vdem"
names(df_Vdem_s)[names(df_Vdem_s) == "e_polity2"]              <- "polity2"
names(df_Vdem_s)[names(df_Vdem_s) == "v2x_ex_military"]        <- "military_centr"
names(df_Vdem_s)[names(df_Vdem_s) == "v2dlencmps"]             <- "spending"
names(df_Vdem_s)[names(df_Vdem_s) == "v2svdomaut"]             <- "autonomy"
names(df_Vdem_s)[names(df_Vdem_s) == "e_regionpol_6C"]         <- "region_pg"
names(df_Vdem_s)[names(df_Vdem_s) == "v2xcs_ccsi"]             <- "civil_soc"
names(df_Vdem_s)[names(df_Vdem_s) == "e_regionpol"]            <- "regio_pol"
names(df_Vdem_s)[names(df_Vdem_s) == "e_regiongeo"]            <- "regio_geo"


# left join with base year
df_Vdem_s <- left_join(df_Base_Y, df_Vdem_s, by = c("year" = "year", "iso3c" = "iso3c"))
df_Vdem_s <- dplyr::select(df_Vdem_s, -country)

#list variables aiddata sectoral
List<- colnames(df_Vdem_s)[!colnames(df_Vdem_s) %in% c("iso3c",
                                                       "year",
                                                       "region")]

## lag variables of 1 to 2 years
df_Vdem_s<-Lag_12(df_Vdem_s, iso3c, List)

#correct names
df_Vdem_s<-janitor::clean_names(df_Vdem_s)

```

## Humanitarian organizations
## https://dataverse.harvard.edu/dataverse/isq
### Import dataset form folder 
```{r}
HOD_Dec_2021 <- read_dta("HOD_Dec_2021.dta")
```

### reshape dataset
```{r}
df_HOD_Dec_2021<-HOD_Dec_2021
## assign iso3c
df_HOD_Dec_2021$iso3c <- countrycode(df_HOD_Dec_2021$COUNTHQ, "cown", "iso3c")
## drop if iso3c is NA
df_HOD_Dec_2021<-Drop_NA(df_HOD_Dec_2021, iso3c)
##assign country name
df_HOD_Dec_2021$c_name<- countrycode(df_HOD_Dec_2021$COUNTHQ, "cown", "country.name")


# keep vars of interest
df_HOD_Dec_2021 <- df_HOD_Dec_2021[c("COUNTHQ",
                                       "iso3c",
                                       "c_name",
                                       "name",
                                       "year")]

# reshape to country panel
## create fake end date to 2021
df_HOD_Dec_2021$end_date<-2021
## drop if year is NA
df_HOD_Dec_2021<-Drop_NA(df_HOD_Dec_2021, year)

## Create date variables
df_HOD_Dec_2021$Date.start <- as.Date(paste0(df_HOD_Dec_2021$year,     "-", "01", "-01"))
df_HOD_Dec_2021$Date.end   <- as.Date(paste0(df_HOD_Dec_2021$end_date, "-", "01", "-01"))


## reshape
# Reshape dataset
df_HOD_Dec_2021_long <- df_HOD_Dec_2021 %>%
  group_by(iso3c, name) %>%
  summarise(date = list(seq(floor_date(min(Date.start), unit = "year"),
                            floor_date(max(Date.end), unit = "year"),
                            by = "year"))) %>%
  unnest(cols = c(date))

# Create variable year
df_HOD_Dec_2021_long$year <- as.double(substr(df_HOD_Dec_2021_long$date, 1, 4))

# collapse to country year and count number of organizations per country
## create dummy for count
df_HOD_Dec_2021_long$count <- 1
## collapse dataset
df_HOD_cy <- df_HOD_Dec_2021_long %>%
  group_by(iso3c, year) %>%
  summarise(count_HO = sum(count))

# left join with base year
df_HOD_cy <- left_join(df_Base_Y, df_HOD_cy, by = c("year" = "year", "iso3c" = "iso3c"))
df_HOD_cy <- dplyr::select(df_HOD_cy, -country)

# assign 0s to NAs
List<-c("count_HO")
df_HOD_cy<-Nas_to_0(df_HOD_cy,List)

# create lags
df_HOD_cy <- Lag_12(df_HOD_cy, iso3c, List)


## subset years of interest
df_HOD_cy<-subset(df_HOD_cy, df_HOD_cy$year>1989)


```

## Conflict activity (UCDP GED)
### Link df: https://ucdp.uu.se/downloads/index.html#ged_global
### Set subfldder name
```{r}
sub_folder_name<-"UCDP"
```

### Create folder and download
```{r}
# download_create_folder_and_unzip(desktop_path,
#                            sub_folder_name,
#                            "https://ucdp.uu.se/downloads/ged/ged231-csv.zip")
```

### Import
```{r}
file_path<-file.path(desktop_path,main_folder_name, sub_folder_name, "GEDEvent_v23_1.csv")

## import  dataset
df_UCDP_GED<- read.csv(file_path)
```


### Reshaping UCDP GED
### Adjusting names of countries, setting variables etc.
```{r}

#assign ISO3
df_UCDP_GED$iso3c <- countrycode(df_UCDP_GED$country, "country.name", "iso3c",
                                 custom_match = c("Yemen (North Yemen)" = "YEM"))

```

### Getting it in a country-year panel format
```{r}

df_UCDP_GED<-df_UCDP_GED[c("iso3c",
                   "year",
                   "type_of_violence",
                   "best")]


## aggregate at country iso3c level
df_UCDP_GED_Y <- df_UCDP_GED %>%
  group_by(iso3c, year, type_of_violence) %>%
   dplyr::summarize(n_fatalities = sum(best, na.rm = TRUE))

#reshape
df_UCDP_GED_Y<-reshape2::dcast(df_UCDP_GED_Y, year+iso3c~`type_of_violence`)

## merge with Base
df_UCDP_GED_Y= left_join(df_Base_Y, df_UCDP_GED_Y, by = c("year" = "year", "iso3c" = "iso3c"))
df_UCDP_GED_Y <- dplyr::select(df_UCDP_GED_Y, -country)

## keep only years after 1990
df_UCDP_GED_Y<-subset(df_UCDP_GED_Y,df_UCDP_GED_Y$year>1989)

#list variables ged
List<- colnames(df_UCDP_GED_Y)[colnames(df_UCDP_GED_Y) %!in% c("iso3c", "year")]

# assign 0s
df_UCDP_GED_Y<-Nas_to_0(df_UCDP_GED_Y,List)

#rename variables
names(df_UCDP_GED_Y)[names(df_UCDP_GED_Y) == "1"] <- "StateBased_conf_fat"
names(df_UCDP_GED_Y)[names(df_UCDP_GED_Y) == "2"] <- "NonState_conf_fat"
names(df_UCDP_GED_Y)[names(df_UCDP_GED_Y) == "3"] <- "OneSided_fat"


## full fatalities
df_UCDP_GED_Y$best_fat<-df_UCDP_GED_Y$StateBased_conf_fat+df_UCDP_GED_Y$NonState_conf_fat+df_UCDP_GED_Y$OneSided_fat


#list variables ged
List<- colnames(df_UCDP_GED_Y)[colnames(df_UCDP_GED_Y) %!in% c("iso3c", "year")]

## create lags
df_UCDP_GED_Y<-Lag_12(df_UCDP_GED_Y, iso3c, List)

```

## (AidData) count number of donors per each country

### prepare dataset
```{r}
df_Aiddata2<-Aiddata

#change names
df_Aiddata2$recipient[df_Aiddata2$recipient=="Yugoslavia"]            <- "Serbia"
df_Aiddata2$recipient[df_Aiddata2$recipient=="Serbia and Montenegro"] <- "Serbia"
df_Aiddata2$recipient[df_Aiddata2$recipient=="Soviet Union"]          <- "Russia"

#assign ISO3
df_Aiddata2$iso3c <- countrycode(df_Aiddata2$recipient, "country.name", "iso3c")

#drop iso3c NAs
df_Aiddata2<-df_Aiddata2[!is.na(df_Aiddata2$iso3c), ]

#assign ISO3 donor
df_Aiddata2$iso3c_donor <- countrycode(df_Aiddata2$donor, "country.name", "iso3c")

```


### count number of donors per country
```{r}

#drop iso3c NAs
df_donors_state<-df_Aiddata2[!is.na(df_Aiddata2$iso3c_donor), ]
df_donors_nonstate<-df_Aiddata2[is.na(df_Aiddata2$iso3c_donor), ]

df_donors_state<- df_donors_state %>% 
    group_by(iso3c, year) %>%
     dplyr::summarize(N_donors_state = n_distinct(donor))

df_donors_nonstate<- df_donors_nonstate %>% 
    group_by(iso3c, year) %>%
     dplyr::summarize(N_donors_nonstate = n_distinct(donor))

  ## merge with base
df_donors_state <- left_join(df_Base_Y, df_donors_state, by = c("year" = "year", "iso3c" = "iso3c"))
df_donors_state <- dplyr::select(df_donors_state, -country)

df_donors_nonstate <- left_join(df_Base_Y, df_donors_nonstate, by = c("year" = "year", "iso3c" = "iso3c"))
df_donors_nonstate <- dplyr::select(df_donors_nonstate, -country)
  

#list variables
List<- c("N_donors_state")
# assign 0s
df_donors_state<-Nas_to_0(df_donors_state,List)
## assign NAs to post 2014
df_donors_state<-df_donors_state %>% mutate(across(List, ~replace(., year > 2013, NA)))


#list variables
List<- c("N_donors_nonstate")
# assign 0s
df_donors_nonstate<-Nas_to_0(df_donors_nonstate,List)
## assign NAs to post 2014
df_donors_nonstate<-df_donors_nonstate %>% mutate(across(List, ~replace(., year > 2013, NA)))


df_donors<- left_join(df_donors_state, df_donors_nonstate, by = c("year" = "year", "iso3c" = "iso3c"))

df_donors$NS_donors_ratio<-df_donors$N_donors_nonstate/(df_donors$N_donors_state+df_donors$N_donors_nonstate)

#list variables aiddata 
List<- c("N_donors_state","N_donors_nonstate","NS_donors_ratio")

## lag variables of 1 to 2 years
df_donors<-Lag_12(df_donors, iso3c, List)
```
## Diego Puga colonial heritage
## https://diegopuga.org/data/rugged/
### Set name folder
```{r}
sub_folder_name<-"Roughness"
```
### download dataset
```{r}

 # download_create_folder_and_unzip(desktop_path,
 #                            sub_folder_name,
 #                           "https://diegopuga.org/data/rugged/rugged_data.zip")

```

### Import
```{r}
file_path<-file.path(desktop_path,main_folder_name, sub_folder_name, "rugged_data.csv")
## import  dataset
df_rugged<- read.csv(file_path)
```

### process
```{r}
#change names
df_rugged$country[df_rugged$country=="Yugoslavia"]            <- "Serbia"
df_rugged$country[df_rugged$country=="Serbia and Montenegro"] <- "Serbia"

#assign ISO3
df_rugged$country <- iconv(df_rugged$country, from = "latin1", to = "UTF-8")
df_rugged$iso3c <- countrycode(df_rugged$country, "country.name", "iso3c")

#drop iso3c NAs
df_rugged<-df_rugged[!is.na(df_rugged$iso3c), ]
```

# Merge datasets main independent and controls
```{r}

## add vdem humanitarian dfs
df_Ind_var <- left_join(df_Vdem_s, df_HOD_cy, by = c("year" = "year", "iso3c" = "iso3c"))
## add WB 
df_Ind_var <- left_join(df_Ind_var, df_WorldBank, by = c("year" = "year", "iso3c" = "iso3c"))
## add conf events
df_Ind_var <- left_join(df_Ind_var, df_UCDP_GED_Y, by = c("year" = "year", "iso3c" = "iso3c"))
## add donors
df_Ind_var <- left_join(df_Ind_var, df_donors, by = c("year" = "year", "iso3c" = "iso3c"))
## add geo and colonial eritage
df_Ind_var <- left_join(df_Ind_var, df_rugged, by = c("iso3c" = "iso3c"))
## Add Aid
df_Ind_var <- left_join(df_Ind_var, df_Aiddata, by = c("year" = "year", "iso3c" = "iso3c"))
## drp years
df_Ind_var <- df_Ind_var[df_Ind_var$year>1994,]

```


# Robustness test fill missing values
```{r}
# #list variables aiddata sectoral
# List<- colnames(df_Ind_var)[!colnames(df_Ind_var) %in% c("iso3c",
#                                                              "year",
#                                                              "country")]
# 
# ## lag variables of 1 to 2 years
# df_Ind_var<-df_Ind_var %>% group_by(iso3c) %>% fill(List, .direction="down")
```

# Export
## Set subfolder name
```{r}
sub_folder_name<-"Compiled"
```

## Create folder
```{r}

# Combine the desktop path with the folder name
folder_path <- file.path(desktop_path, main_folder_name, sub_folder_name)

# Check if the folder exists
if (!file.exists(folder_path)) {
  # If the folder doesn't exist, create it
  dir.create(folder_path)
  cat("Folder", main_folder_name, "created on the desktop.\n")
} else {
  # If the folder already exists, do nothing
  cat("Folder", main_folder_name, "already exists on the desktop.\n")
}
```

## Export file
```{r}
#saving it
namefile<-"df_Ind_var_v3.rds"
folder_path <- file.path(desktop_path, main_folder_name, sub_folder_name, namefile)
#folder_path_wb <-(paste0(userpath,"Nextcloud/Global Solidarity/Compiled/df_Ind_var.rds"))
saveRDS(df_Ind_var, folder_path)

```


