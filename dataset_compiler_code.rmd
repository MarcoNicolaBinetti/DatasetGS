---
title: "DatasetCompiler"
author: "MNB"
date: "2/15/2024"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Libraries
```{r}
library(Hmisc)
library(data.table)

library(R.utils)
library(plyr)
library(dplyr)
library(tidyverse)
library(tidyr)
library(naniar)
library(geosphere)
library(zoo)
library(stringr)
library(tidytext)
library(rworldmap)
library(gridExtra)


library(classInt)
library("ggplot2")
library(devtools)
library(DT)
library(dvmisc)
library(ggpubr)
library(gtools)
library(foreign)
library(GADMTools)
library(maps)


library(spdep)
library(lubridate)


library(WDI)
library(readxl)
library(haven)


library(reshape)

library(geojsonio)

library(countrycode)

library(roll)
```

# Remove lists 
```{r, include=FALSE}
## remove lists
rm(list=ls())
```

# Funtions 
```{r}
# more lines of code

# calcolate mode
mode <- function(v) {
  uniqv <- unique(v)
  uniqv[which.max(tabulate(match(v, uniqv)))]
}


# exclude
'%!in%' <- function(x,y)!('%in%'(x,y))

drop_columns <- function(data, columns_to_drop) {
  data <- data[, names(data) %!in% columns_to_drop, drop = FALSE]
  return(data)
}


## drop NAs from column
Drop_NA <- function(dataset, col_name){
  col_name <- enquo(col_name)
  dataset %>%
    drop_na((!!col_name)) %>%
    as.data.frame()
}

## create 1 and 2 period lags (grouping by a variable)
Lag_12 <- function(dataset,col_name,x){
  {
    col_name <- enquo(col_name)
    dataset %>%
      group_by(!!col_name) %>%
      mutate(across(all_of(x),
                    .fns = ~ lag(.,1),
                    .names = paste0("{.col}_lag_",1)))%>%
      mutate(across(all_of(x),
                    .fns = ~ lag(.,2),
                    .names = paste0("{.col}_lag_",2)))
    
  } 
}

## create 1 and 2 period lags 
Lag_12_ngby <- function(dataset,x){
  {
    dataset %>%
      mutate(across(all_of(x),
                    .fns = ~ lag(.,1),
                    .names = paste0("{.col}_lag_",1)))%>%
      mutate(across(all_of(x),
                    .fns = ~ lag(.,2),
                    .names = paste0("{.col}_lag_",2)))
    
  } 
}

## assign 0 to NAs
Nas_to_0 <- function(dataset, x) {
  
  dataset %>% mutate_at(all_of(x), ~replace(., is.na(.), 0))
  
}


download_and_create_folder <- function(file_name, desktop_path, folder_name, url) {
  
  # Combine the desktop path with the folder name
  folder_path <- file.path(desktop_path,main_folder_name, folder_name)
  
  
  # Check if the folder exists
  if (!file.exists(folder_path)) {
    # If the folder doesn't exist, create it
    dir.create(folder_path)
    cat("Folder", folder_path, "created.\n")
  } else {
    # If the folder already exists, do nothing
    cat("Folder", folder_path, "already exists.\n")
  }
  
  # Specify the file path where you want to save the downloaded file
  file_path <- paste0(folder_path, "/", file_name)
  
  # Download the file
  download.file(url, file_path, mode = "wb")
}




download_create_folder_and_unzip <- function(desktop_path, folder_name, url) {
  
  # Combine the desktop path with the folder name
  folder_path <- file.path(desktop_path,main_folder_name, folder_name)
  
  
  # Check if the folder exists
  if (!file.exists(folder_path)) {
    # If the folder doesn't exist, create it
    dir.create(folder_path)
    cat("Folder", folder_path, "created.\n")
  } else {
    # If the folder already exists, do nothing
    cat("Folder", folder_path, "already exists.\n")
  }
  
  # Specify the file path where you want to save the downloaded file
  file_path <- folder_path
  
  # Download the file
  download.file(url, destfile = "temp.zip", mode = "wb")
  
  # Unzip the downloaded file
  unzip("temp.zip", exdir = file_path)
  
  # Delete the temporary zip file
  file.remove("temp.zip")
}

```


# Setting directory for datasets' folders
```{r}
desktop_path <- file.path("C:", "Users", "marco", "Desktop")
```


# Creating folder for datasets
```{r}
# Define the path to the desktop folder

# Define the name of the folder to check/create
main_folder_name <- "DFGlobalLab"

# Combine the desktop path with the folder name
folder_path <- file.path(desktop_path, main_folder_name)

# Check if the folder exists
if (!file.exists(folder_path)) {
  # If the folder doesn't exist, create it
  dir.create(folder_path)
  cat("Folder", main_folder_name, "created on the desktop.\n")
} else {
  # If the folder already exists, do nothing
  cat("Folder", main_folder_name, "already exists on the desktop.\n")
}
```

# Importing and reshaping Dfs

### Polity 2
#### Set subfolder name
```{r}
sub_folder_name<-"polity2"
```

#### Create folder and download
```{r}
download_and_create_folder("p5v2018.xls",
                           desktop_path,
                           sub_folder_name,
                           "http://www.systemicpeace.org/inscr/p5v2018.xls")
```

#### Import
```{r}
file_path<-file.path(desktop_path,main_folder_name, sub_folder_name, "p5v2018.xls")
## import  dataset
Polity2<- read_excel(file_path)
```

# Create bases - at year and month levels
```{r}
df_Polity2<-Polity2

# Create base at year level
## assign ISO3C
df_Polity2$iso3c <- countrycode(df_Polity2$country, "country.name", "iso3c")
## subset years of interests
df_Polity2<-subset(df_Polity2, df_Polity2$year>1980 & Polity2$year<2020)
## subset only columns of interest
df_Base_Y<-df_Polity2[c("country",
                        "iso3c",
                        "year")]
## drop iso3c NA
df_Base_Y<-Drop_NA(df_Base_Y, iso3c)
## correct names
df_Base_Y<-janitor::clean_names(df_Base_Y)


# Create base at month level
## set list of countries
Countries<-as.data.frame(unique(df_Base_Y$country))
names(Countries)[1] <- "country"
Countries$Dummy<-1
## assign ISO3C
Countries$iso3c <- countrycode(Countries$country, "country.name", "iso3c")
## set list of months
Date<-as.data.frame(seq(as.Date("1980-1-1"), as.Date("2021-12-31"), by = "month"))
names(Date)[1] <- "Date.month"
Date$Dummy<-1
Date$Date.month<-as.yearmon(Date$Date.month)
## create base
df_Base_YM<-left_join(Countries,Date)
## drop dummy
List<-c("Dummy")
df_Base_YM<-drop_columns(df_Base_YM,List)
## create year variable
df_Base_YM$year <- as.integer(c((substr(( c(df_Base_YM$Date.month)), 5, 8))))

## correct names
df_Base_YM<-janitor::clean_names(df_Base_YM)


```

### EMDAT
#### Link df: https://www.emdat.be/database (for EMdat there is no API and a format to download. thus I sugest to manually create a subfolder named EMDAT in the folder DFGlobalLab and save there the EMdat dataset manually downloaded from here: https://public.emdat.be/data. on February 17th I downloaded the dataset selecting both natural and technological disasters in the form "classification", and selecting all the continets in the from "countries". For the time period I selected 1980 - 2020. I transofremd the file in a STATA dataset and uploaded the file on github under the name emdat) 
#### Set subfolder name
```{r}
sub_folder_name<-"EMDAT"
```
#### Importing dataset
```{r}
file_path<-file.path(desktop_path,main_folder_name, sub_folder_name, "emdat.dta")
## import  dataset
EMDAT<- haven::read_dta(file_path)
```

#### Reshaping EMDAT
##### Adjusting names of countries, setting variables etc.
```{r}
EM_dat<-EMDAT
##subset years
EM_dat<-subset(EM_dat, EM_dat$StartYear>=1980)

#select variables of interests
EM_dat<-EM_dat[c("DisNo",
                 "StartYear",
                 "EndYear",
                 "StartMonth",
                 "EndMonth",
                 "DisasterGroup",
                 "DisasterSubgroup",
                 "DisasterType",
                 "DisasterSubtype",
                 "ISO",
                 "Country")]

#rename variables
names(EM_dat)[names(EM_dat) == "Year"] <- "year"
names(EM_dat)[names(EM_dat) == "Country"] <- "country_Emdat"

#drop events without date
EM_dat<-EM_dat[!(is.na(EM_dat$`StartMonth`)),]
EM_dat<-EM_dat[!(is.na(EM_dat$`EndMonth`)),]

#create  dates event and start datasets
EM_dat$Date.start <- paste0(EM_dat$`StartYear`,
                            "-",
                            EM_dat$`StartMonth`)

EM_dat$Date.start<-as.yearmon(EM_dat$Date.start)


EM_dat$Date.end <- paste0(EM_dat$`EndYear`,
                            "-",
                            EM_dat$`EndMonth`)

EM_dat$Date.end<-as.yearmon(EM_dat$Date.end)

#as date
EM_dat$Date.start<-as.Date(EM_dat$Date.start)
EM_dat$Date.end<-as.Date(EM_dat$Date.end)

#rename countries
# Define replacements using a named vector
replacements <- c(
  "Czechoslovakia" = "Czech Republic (the)",
  "Germany Fed Rep" = "Germany",
  "Korea (the Republic of)" = "Korea South",
  "Korea (the Democratic People's Republic of)" = "Korea North",
  "Serbia Montenegro" = "Serbia",
  "Yugoslavia" = "Serbia"
)

# Apply replacements using named vector and %in% operator
EM_dat$country_Emdat <- ifelse(EM_dat$country_Emdat %in% names(replacements), replacements[EM_dat$country_Emdat], EM_dat$country_Emdat)

#create iso3c
EM_dat$iso3c <- countrycode(EM_dat$country_Emdat, "country.name", "iso3c")

#drop iso3c NAs
EM_dat<-EM_dat[!is.na(EM_dat$iso3c), ]


#subset variables
EM_dat<-EM_dat[c("DisNo",
                 "iso3c",
                 "DisasterSubgroup",
                 "Date.start",
                 "Date.end")]
#sort dataset
EM_dat<-EM_dat[
  with(EM_dat, order(iso3c, Date.start)),
]
```

##### Getting it in a country-year-month panel format
```{r}
#reshape dataset
EM_dat_ym<-EM_dat %>%
  group_by(iso3c, `DisNo`, `DisasterSubgroup`) %>%
  summarise(date = list(seq(floor_date(min(Date.start),unit = "month"),
                            floor_date(max(Date.end), unit = "month"),
                            by = "month"))) %>%
  tidyr::unnest(cols = c(date))

#sort dataframe
EM_dat_ym<-EM_dat_ym[
  with(EM_dat_ym, order(iso3c, date)),
]

#create dummy for  count
EM_dat_ym$count<-1

# count events
EM_dat_ym<- EM_dat_ym %>%
  group_by(iso3c, `DisasterSubgroup`, date ) %>%
  summarize(count = sum(count))

#reshape
EM_dat_ym<-reshape2::dcast(EM_dat_ym, date+iso3c~`DisasterSubgroup`)


#merge with vector dates countries
EM_dat_ym$Date_month<-as.yearmon(EM_dat_ym$date)
EM_dat_ym= left_join(df_Base_YM, EM_dat_ym, by = c("date_month" = "Date_month", "iso3c" = "iso3c"))

#list variables MDat
List<- colnames(EM_dat_ym)[colnames(EM_dat_ym) %!in% c("iso3c", "dummy", "date_month", "date")]

# assign 0s
EM_dat_ym<-Nas_to_0(EM_dat_ym,List)

## drop date
List<-c("date")
EM_dat_ym<-drop_columns(EM_dat_ym,List)

#create variable year
EM_dat_ym$year<-as.double((substr(( c(EM_dat_ym$date_month)), 5, 9)))

#correct names
EM_dat_ym<-janitor::clean_names(EM_dat_ym)

## create dummy variables to account if a country in a given month experienced a disaster or not
# Specify the names of the variables to recode
List<- colnames(EM_dat_ym)[!colnames(EM_dat_ym) %in% c("iso3c",
                                                       "year",
                                                       "date_month",
                                                       "country")]
# Recode each selected variable
EM_dat_ym[List] <- lapply(EM_dat_ym[List], function(x) ifelse(x > 0, 1, 0))

# Rename variables by adding "_dummy" suffix
for (var in List) {
  new_name <- paste0(var, "_dummy")
  colnames(EM_dat_ym)[colnames(EM_dat_ym) == var] <- new_name
}

## create lags
# Specify the names of the variables to recode
List<- colnames(EM_dat_ym)[!colnames(EM_dat_ym) %in% c("iso3c",
                                                       "year",
                                                       "date_month",
                                                       "country")]
#code lags
EM_dat_ym<-Lag_12(EM_dat_ym, iso3c, List)

```

##### Getting it in a country-year panel format
```{r}
# collapse to the counry-year level. for each country count the number of months experiencing the generic disaster D
EM_dat_y<- EM_dat_ym %>% 
  group_by(iso3c, year ) %>%
  summarize(ext_ter_n_m = sum(extra_terrestrial_dummy),
            geo_n_m = sum(geophysical_dummy),
            hydro_n_m = sum(hydrological_dummy),
            indu_n_m = sum(industrial_accident_dummy),
            meteo_n_m = sum(meteorological_dummy),
            misc_n_m = sum(miscellaneous_accident_dummy),
            transport_n_m = sum(transport_dummy),
            bio_n_m = sum(biological_dummy),
            climat_n_m = sum(climatological_dummy))

# create dummy variables to account if a country in a given month experienced a disaster or not
## Specify the names of the variables you want to recode
List<- colnames(EM_dat_y)[!colnames(EM_dat_y) %in% c("iso3c", "year")]
## Create new variables with "_dummy" suffix
for (variable in List) {
  # Extract the name without suffix
  new_name <- sub("_n_m$", "_dummy", variable)
  
  # Create new variable with suffix "_dummy"
  EM_dat_y[[new_name]] <- ifelse(EM_dat_y[[variable]] == 0, 0, 1)
}


## merge with Base
EM_dat_y= left_join(df_Base_Y, EM_dat_y, by = c("year" = "year", "iso3c" = "iso3c"))

#list variables MDat
List<- colnames(EM_dat_y)[!colnames(EM_dat_y) %in% c("iso3c", "year")]

# assign 0s
EM_dat_y<-Nas_to_0(EM_dat_y,List)

# Lag 12
EM_dat_y <-Lag_12(EM_dat_y,iso3c, List)

# correct names
EM_dat_y<-janitor::clean_names(EM_dat_y)

```

### UCDP GED
#### Link df: https://ucdp.uu.se/downloads/index.html#ged_global
#### Set subfldder name
```{r}
sub_folder_name<-"UCDP"
```

#### Create folder and download
```{r}
download_create_folder_and_unzip(desktop_path,
                           sub_folder_name,
                           "https://ucdp.uu.se/downloads/ged/ged231-csv.zip")
```

#### Import
```{r}
file_path<-file.path(desktop_path,main_folder_name, sub_folder_name, "GEDEvent_v23_1.csv")
## import  dataset
UCDP_GED<- read.csv(file_path)
```


#### Reshaping UCDP GED
##### Adjusting names of countries, setting variables etc.
```{r}
df_UCDP_GED<-UCDP_GED

#assign ISO3
df_UCDP_GED$iso3c <- countrycode(df_UCDP_GED$country, "country.name", "iso3c")

#create year month date
            df_UCDP_GED$month <- c((substr(( c(df_UCDP_GED$date_start)), 6, 7)))
            df_UCDP_GED$day<- c((substr(( c(df_UCDP_GED$date_start)), 9, 10)))

            df_UCDP_GED$day.month.year <- as.character(paste0(df_UCDP_GED$month,
                                                          "/",
                                                          df_UCDP_GED$day,
                                                          "/",
                                                          df_UCDP_GED$year))

            df_UCDP_GED$month.year <- as.character(paste0(df_UCDP_GED$year,
                                                      "-",
                                                      df_UCDP_GED$month))

            df_UCDP_GED$Date<-as.Date(df_UCDP_GED$day.month.year, format = "%m/%d/%Y")
            df_UCDP_GED$date_month<-as.yearmon(df_UCDP_GED$month.year)
```

##### Getting it in a country-year-month panel format
```{r}
# aggregate at country year month level
df_UCDP_GED_m<- df_UCDP_GED %>% 
  group_by(iso3c, year, month, date_month, type_of_violence) %>%
  summarize(n_fatalities = sum(best))


# reshape
df_UCDP_GED_m<-reshape2::dcast(df_UCDP_GED_m, year+date_month+iso3c~`type_of_violence`)

## merge with Base
df_UCDP_GED_m= left_join(df_Base_YM, df_UCDP_GED_m, by = c("date_month" = "date_month","year" = "year", "iso3c" = "iso3c"))

# list variables ged
List<- colnames(df_UCDP_GED_m)[colnames(df_UCDP_GED_m) %!in% c("iso3c",
                                                               "year",
                                                               "country",
                                                               "date_month")]

# assign 0s
df_UCDP_GED_m<-Nas_to_0(df_UCDP_GED_m,List)

#rename variables
names(df_UCDP_GED_m)[names(df_UCDP_GED_m) == "1"] <- "StateBased_conf_fat"
names(df_UCDP_GED_m)[names(df_UCDP_GED_m) == "2"] <- "NonState_conf_fat"
names(df_UCDP_GED_m)[names(df_UCDP_GED_m) == "3"] <- "OneSided_fat"

# create dummy variable conflict ongoin (at least 25 battle-related fatalities in a given year in a given country)
df_UCDP_GED_m$dummy_conf<-ifelse(df_UCDP_GED_m$StateBased_conf_fat>24,1,0)

# list variables ged
List<- colnames(df_UCDP_GED_m)[colnames(df_UCDP_GED_m) %!in% c("iso3c",
                                                               "year",
                                                               "country",
                                                               "date_month")]

# Replace values with NA for years before 1989
df_UCDP_GED_m[df_UCDP_GED_m$year < 1989, List] <- NA


## create lags
df_UCDP_GED_m<-Lag_12(df_UCDP_GED_m, iso3c, List)

```

##### Getting it in a country-year panel format
```{r}
## aggregate at country iso3c level
df_UCDP_GED_Y<- df_UCDP_GED %>% 
  group_by(iso3c, year, type_of_violence) %>%
  summarize(n_fatalities = sum(best))

#reshape
df_UCDP_GED_Y<-reshape2::dcast(df_UCDP_GED_Y, year+iso3c~`type_of_violence`)

## merge with Base
df_UCDP_GED_Y= left_join(df_Base_Y, df_UCDP_GED_Y, by = c("year" = "year", "iso3c" = "iso3c"))

#list variables ged
List<- colnames(df_UCDP_GED_Y)[colnames(df_UCDP_GED_Y) %!in% c("iso3c", "year")]

# assign 0s
df_UCDP_GED_Y<-Nas_to_0(df_UCDP_GED_Y,List)

#rename variables
names(df_UCDP_GED_Y)[names(df_UCDP_GED_Y) == "1"] <- "StateBased_conf_fat"
names(df_UCDP_GED_Y)[names(df_UCDP_GED_Y) == "2"] <- "NonState_conf_fat"
names(df_UCDP_GED_Y)[names(df_UCDP_GED_Y) == "3"] <- "OneSided_fat"

## create dummy variable conflict ongoin (at least 25 battle-related fatalities in a given year in a given country)
df_UCDP_GED_Y$dummy_conf<-ifelse(df_UCDP_GED_Y$StateBased_conf_fat>24,1,0)

#list variables ged
List<- colnames(df_UCDP_GED_Y)[colnames(df_UCDP_GED_Y) %!in% c("iso3c", "year")]

## create lags
df_UCDP_GED_Y<-Lag_12(df_UCDP_GED_Y, iso3c, List)
```

### ICEWS
#### Link df: https://dataverse.harvard.edu/dataverse/icews?q=&types=files&sort=dateSort&order=desc&page=5 (in the Dropboy folder you find in the folder ICWES and subfoder years all the original .tab files of events from the dataset. just copy them in the local foder that is created with the following code)

#### Set subfolder name
```{r}
sub_folder_name <- "ICEWS"
```

#### Creating folder for ICEWS
```{r}
folder_path <- file.path(desktop_path,main_folder_name, sub_folder_name)

# Check if folder already exists
if (!file.exists(folder_path)) {
  # If not, create the folder
  dir.create(folder_path)
  print(paste("Folder", folder_path, "created."))
} else {
  print(paste("Folder", folder_path, "already exists."))
}
```

#### Importing ICEWS from row data
```{r}
#import datasets
ldf <- list() # creates a list

for (k in 1995:2021){

 year<-paste0("",k,"")
 File<-paste0("G:/My Drive/Research/CSTM/ICEWS/years/events.",year,".tab")
 df<- read.delim(File, header = TRUE, quote = "")
 df<-df[c(1:11)]
 names(df)[1] <- "event_id"
 names(df)[2] <- "event_date"
 names(df)[3] <- "source_name"
 names(df)[4] <- "source_sector"
 names(df)[5] <- "source_country"
 names(df)[6] <- "event_text"
 names(df)[7] <- "cameo_code"
 names(df)[8] <- "intensity"
 names(df)[9] <- "target_name"
 names(df)[10] <- "target_sectors"
 names(df)[11] <- "target_country"

 ldf[[k]]<-df

}

#bind datasets
df_ICWES <- do.call(rbind, ldf)
# drop list
rm(ldf)

#correct entries (f*ck 2015,2016 datastes)
## Define the columns to apply the transformation to
List <- c("source_name", "source_sector", "source_country", "target_name", "target_country")

## Apply gsub function to selected columns using mutate_at
df_ICWES <- df_ICWES %>% 
  mutate_at(vars(List), ~gsub("[^\\p{L}0-9\\s]", "", ., perl = TRUE))

```

#### Saving ICEWS events as a full rds file to save time when loading it
```{r}
URL_df<-paste0(folder_path,"/", "df_ICWES.rds")
# saving icews df
saveRDS(df_ICWES, URL_df)

```

#### Importing ICEWS from the rds. file. this helps to skip the "Importing ICEWS from row data" block of code
```{r}
# importing icews df
df_ICWES <- readRDS(URL_df)
```

#### Reshaping ICEWS 
##### Adjusting names of countries, setting variables etc.
```{r}
#create dummy event
df_ICWES$Event_ICEWS<-1
#set date
df_ICWES$Date.month<-as.yearmon(df_ICWES$event_date)

## create year
df_ICWES$year <- as.integer(c((substr(( c(df_ICWES$Date.month)), 5, 8))))

#set ISO3C
df_ICWES$iso3c_target <- countrycode(df_ICWES$target_country, "country.name", "iso3c")
df_ICWES$iso3c_source <- countrycode(df_ICWES$source_country, "country.name", "iso3c")
#drop NA
df_ICWES<-Drop_NA(df_ICWES, iso3c_target)
df_ICWES<-Drop_NA(df_ICWES, iso3c_source)

# keep only state based events
## create dummy if sender is government and receiver is government
df_ICWES$gov_sender<-ifelse(grepl("Govern", df_ICWES$source_sector),1,0)
df_ICWES$gov_target<-ifelse(grepl("Govern", df_ICWES$target_sectors),1,0)
```

##### subsetting events of interest
```{r}
## subset dataset
df_ICWES_g2g<-subset(df_ICWES, df_ICWES$gov_sender==1 &
                               df_ICWES$gov_target==1)

# Define the columns to apply the transformation to
List <- c("event_text")

# Apply gsub function to selected columns using mutate_at
df_ICWES_g2g <- df_ICWES_g2g %>% 
  mutate_at(vars(List), ~gsub("[^\\p{L}0-9\\s]", "", ., perl = TRUE))

# keep only expressions to cooperate
## create var =1 if event is an expression of intent
df_ICWES_g2g$express_int<-ifelse(grepl("Express intent to", df_ICWES_g2g$event_text),1,0)
## keep only expressions of intent to cooperate
df_ICWES_g2g<-subset(df_ICWES_g2g, df_ICWES_g2g$express_int==1)

# keep only expressions between two different countries
## create dummy variable to identfy cross-country expressions
df_ICWES_g2g$inter_gov <-0
df_ICWES_g2g$inter_gov[df_ICWES_g2g$iso3c_source!=df_ICWES_g2g$iso3c_target] <-1  
## keeping only inter_gov expressions
df_ICWES_g2g<-subset(df_ICWES_g2g, df_ICWES_g2g$inter_gov==1)

# drop inter gov expressions of intent to cooperate clearly unrelated to humanitarian aid
## List of strings to drop
List <- c("Express intent to cooperate militarily",
          "Express intent to cooperate on judicial matters",
          "Express intent to institute political reform",
          "Express intent to meet or negotiate",
          "Express intent to provide military aid",
          "Express intent to release persons or property",
          "Express intent to yield",
          "Express intent to change leadership",
          "Express intent to cooperate on intelligence",
          "Express intent to deescalate military engagement",
          "Express intent to mediate",
          "Express intent to provide military protection or peacekeeping",
          "Express intent to settle dispute",
          "Express intent to ease administrative sanctions",
          "Express intent to accept mediation")

## Dropping observations containing strings in the list
df_ICWES_g2g <- subset(df_ICWES_g2g, (event_text %!in% List))


# drop useless vars
List<-c("gov_sender",
        "gov_target",
        "express_int",
        "inter_gov")

df_ICWES_g2g<-drop_columns(df_ICWES_g2g,List)

## correct names
df_ICWES_g2g<-janitor::clean_names(df_ICWES_g2g)


## merge with emdat country month level dataset in order to identify declarations 
df_ICWES_g2g= left_join(df_ICWES_g2g, EM_dat_ym, by = c("date_month" = "date_month", "iso3c_target" = "iso3c", "year"="year"))


```

##### Remove from environment df_ICWES to save memory
```{r}
rm(df_ICWES)
```


##### Calculating number of verbal support a country receives per month
```{r}
# # count events
# df_ICWES_m<- df_ICWES %>% 
#   group_by(iso3c, Event.Text, Date.month ) %>%
#   summarize(Event_ICEWS = sum(Event_ICEWS))
# 
# #reshape
# df_ICWES_m<-reshape2::dcast(df_ICWES_m, Date.month+iso3c~Event.Text)

```

##### Calculating number of verbal support a country receives during natural disaster per month
```{r}
# keep only observations occurred during a disaster or at max 2 months by it
## List of dummy variables
dummy_vars <- grep("dummy", names(df_ICWES_g2g), value = TRUE)

## Create the 'disaster' variable
df_ICWES_g2g$disaster <- as.numeric(rowSums(df_ICWES_g2g[dummy_vars]) > 0)
## drop non disaster observations
df_ICWES_g2g_dis<-subset(df_ICWES_g2g,df_ICWES_g2g$disaster==1)

df_ICWES_g2g_dis$Express_exist<-1

# count events
# aggregate at country year month level
df_ICWES_g2g_dis_m<- df_ICWES_g2g_dis %>% 
  group_by(iso3c_target, year, date_month, event_text) %>%
  summarize(count = sum(Express_exist))


#reshape
df_ICWES_g2g_dis_m<-reshape2::dcast(df_ICWES_g2g_dis_m, date_month+iso3c_target~event_text)

## rename variables
names(df_ICWES_g2g_dis_m)[names(df_ICWES_g2g_dis_m) == "Year"] <- "year"
names(df_ICWES_g2g_dis_m)[names(df_ICWES_g2g_dis_m) == "Country"] <- "country_Emdat"


```

##### Calculating number of verbal support a country receives during conflict per month
```{r}

```

### AidData
#### Link df: https://www.aiddata.org/data/aiddata-core-research-release-level-1-v3-0#### Create folder and download
#### Set name folder
```{r}
sub_folder_name<-"Aidata"
```
#### Create folder and download
```{r}
download_create_folder_and_unzip(desktop_path,
                           sub_folder_name,
                           "https://github.com/AidData-WM/public_datasets/releases/download/v3.0/AidDataCore_ResearchRelease_Level1_v3.0.zip")
```

#### Import
```{r}
file_path<-file.path(desktop_path,main_folder_name, sub_folder_name, "AidDataCoreDonorRecipientYearPurpose_ResearchRelease_Level1_v3.0.csv")
## import  dataset
Aiddata<- read.csv(file_path)
```


#### Reshaping AidData 
##### Calculating total amount of aid
```{r}
df_Aiddata<-Aiddata

## aggregate at country recipient level
df_Aiddata<- df_Aiddata %>% 
  group_by(recipient, year ) %>%
  summarize(AidData_tot_commit = sum(commitment_amount_usd_constant_sum))

#change names
df_Aiddata$recipient[df_Aiddata$recipient=="Yugoslavia"] <- "Serbia"
df_Aiddata$recipient[df_Aiddata$recipient=="Serbia and Montenegro"] <- "Serbia"
df_Aiddata$recipient[df_Aiddata$recipient=="Soviet Union"] <- "Russia"

#assign ISO3
df_Aiddata$iso3c <- countrycode(df_Aiddata$recipient, "country.name", "iso3c")

#drop iso3c NAs
df_Aiddata<-df_Aiddata[!is.na(df_Aiddata$iso3c), ]

#create Aiddata country date dataset
df_Aiddata_C<-as.data.frame(unique(df_Aiddata$iso3c))
names(df_Aiddata_C)[1] <- "iso3c"
df_Aiddata_C$Dummy<-1
Date_Y_AidData<-as.data.frame(seq(as.Date("1970-1-1"), as.Date("2013-12-31"), by = "year"))
names(Date_Y_AidData)[1] <- "year"
Date_Y_AidData$Dummy<-1
Date_Y_AidData$year<-as.double((substr(( c(Date_Y_AidData$year)), 1, 4)))
df_Aiddata_CY<-left_join(df_Aiddata_C,Date_Y_AidData)

# merge with with aid data country year vector
df_Aiddata<-left_join(df_Aiddata_CY,df_Aiddata, by = c("iso3c" = "iso3c","year"="year"))

#drop duplicates (usual yuogoslavia and soviet union "problem" with name change to serbia and russia)
df_Aiddata<-df_Aiddata %>% 
                distinct(year, iso3c , .keep_all = TRUE)

## merge with world Bank Population
WorldBank_pop <- WDI(
  country = "all",
  indicator = c("Pop_tot"="SP.POP.TOTL"),
  start = 1960,
  end = 2020,
  extra = TRUE,
  cache = NULL,
  latest = NULL,
  language = "en"
)

## assign ISO3
names(WorldBank_pop)[names(WorldBank_pop) == "country"] <- "country_wb"
WorldBank_pop$iso3c <- countrycode(WorldBank_pop$country_wb, "country.name", "iso3c")

# merge with aid data 
df_Aiddata<-left_join(df_Aiddata,WorldBank_pop)

##assign 0s and NAs
List<-c("AidData_tot_commit")
df_Aiddata<-Nas_to_0(df_Aiddata, List)

#divide by population
df_Aiddata$AidData_tot_commit_per_cap<-df_Aiddata$AidData_tot_commit/df_Aiddata$Pop_tot

# keep var of interest
df_Aiddata <- df_Aiddata[ , !names(df_Aiddata) %in% c("Dummy",
                                                      "iso2c",
                                                      "country_wb",
                                                      "Pop_tot",
                                                      "region",
                                                      "capital",
                                                      "longitude",
                                                      "latitude",
                                                      "income",
                                                      "lending")]
## merge with Base
df_Aiddata= left_join(df_Base, df_Aiddata, by = c("year" = "year", "iso3c" = "iso3c"))

#list variables MDat
List<- colnames(df_Aiddata)[!colnames(df_Aiddata) %in% c("iso3c", "year")]

# assign 0s
df_Aiddata<-Nas_to_0(df_Aiddata,List)

```

##### Calculating total amount of aid by sector per recipient country per each year
```{r}
#load dataset
df_Aiddata_sectoral<-Aiddata

#create schort code
df_Aiddata_sectoral$Short_code<-c((substr(( c(df_Aiddata_sectoral$coalesced_purpose_code)), 1, 2)))

## rename codes
# Define replacements using a named vector
replacements <- c(
  "10" = "Social_Infra",
  "11" = "Education",
  "12" = "Health",
  "13" = "Population_Policies",
  "14" = "Water_Supply_Sanitation",
  "15" = "Gov_Civ_Soc",
  "16" = "Soc_Infra",
  "20" = "Eco_Infra",
  "21" = "Trans_Stor",
  "22" = "Comm",
  "23" = "Energy_Gen_Supp",
  "24" = "Banking",
  "25" = "Business",
  "30" = "Production Sectors",
  "31" = "Agri_For_Fish",
  "32" = "Ind_Min_Cons",
  "33" = "Trade_policy",
  "41" = "Env_Protection",
  "42" = "Women",
  "43" = "Other",
  "51" = "Budget_Support",
  "52" = "Food_Security",
  "53" = "Commodity_Assistance",
  "60" = "Debt",
  "70" = "Humanitarian_Aid",
  "72" = "Emergency_Response",
  "73" = "Reconstruction_Relief",
  "74" = "Disaster_Prevention",
  "91" = "Administrative_costs",
  "92" = "Support_NGO",
  "93" = "Refugees_Donor",
  "99" = "Unallocated"
)

# Apply replacements using named vector and %in% operator
df_Aiddata_sectoral$Short_code <- replacements[as.character(df_Aiddata_sectoral$Short_code)]

#change names countries
df_Aiddata_sectoral$recipient[df_Aiddata_sectoral$recipient=="Yugoslavia"] <- "Serbia"
df_Aiddata_sectoral$recipient[df_Aiddata_sectoral$recipient=="Serbia and Montenegro"] <- "Serbia"
df_Aiddata$recipient[df_Aiddata$recipient=="Soviet Union"] <- "Russia"

#assign ISO3
df_Aiddata_sectoral$iso3c <- countrycode(df_Aiddata_sectoral$recipient, "country.name", "iso3c")

#drop iso3c NAs
df_Aiddata_sectoral<-df_Aiddata_sectoral[!is.na(df_Aiddata_sectoral$iso3c), ]

## aggregate at country recipient purpose level
df_Aiddata_sectoral<- df_Aiddata_sectoral %>% 
  group_by(iso3c, year,Short_code ) %>%
  summarize(commitment_tot = sum(commitment_amount_usd_constant_sum))

# merge with with aid data country year vector
df_Aiddata_sectoral<-left_join(df_Aiddata_CY,df_Aiddata_sectoral, by = c("iso3c" = "iso3c","year"="year"))

## merge with wb
df_Aiddata_sectoral<-left_join(df_Aiddata_sectoral,WorldBank_pop, by = c("iso3c" = "iso3c","year"="year"))

#divide by population
df_Aiddata_sectoral$commit_per_cap<-df_Aiddata_sectoral$commitment_tot/df_Aiddata_sectoral$Pop_tot

# keep var of interest
df_Aiddata_sectoral <- df_Aiddata_sectoral[ ,  names(df_Aiddata_sectoral) %in% c("iso3c",
                                                                                  "year",
                                                                                  "Short_code",
                                                                                  "commit_per_cap",
                                                                                  "commitment_tot")]

#reshape
dcast1 <- reshape2::dcast(df_Aiddata_sectoral, iso3c + year ~ Short_code, value.var="commit_per_cap")
dcast2 <- reshape2::dcast(df_Aiddata_sectoral, iso3c + year ~ Short_code, value.var="commitment_tot")

#rename vars
cols_to_rename <- names(dcast1)[!(names(dcast1) %in% c("year", "iso3c"))]
dcast1 <- dcast1 %>%
  rename_with(~ paste0(., "_pc"), cols_to_rename)
dcast2 <- dcast2 %>%
  rename_with(~ paste0(., "_tot"), cols_to_rename)

# merge with dcast1 and dcast2 with aid data country year vector
df_Aiddata_sectoral<-left_join(df_Aiddata_CY, dcast1, by = c("iso3c" = "iso3c","year"="year"))
df_Aiddata_sectoral<-left_join(df_Aiddata_sectoral, dcast2, by = c("iso3c" = "iso3c","year"="year"))


#assign 0s
df_Aiddata_sectoral[is.na(df_Aiddata_sectoral)] = 0


#drop duplicates
df_Aiddata_sectoral<-df_Aiddata_sectoral %>% 
                distinct(year, iso3c , .keep_all = TRUE)

## merge with Base
df_Aiddata= left_join(df_Base, df_Aiddata, by = c("year" = "year", "iso3c" = "iso3c"))

#list variables MDat
List<- colnames(df_Aiddata)[!colnames(df_Aiddata) %in% c("iso3c", "year")]

# assign 0s
df_Aiddata<-Nas_to_0(df_Aiddata,List)

```

##### Calculating total amount of aid by sector commited worldwide per each year
```{r}

```


### ESD
#### Link df https://ucdp.uu.se/downloads/index.html#externalsupport
#### Create folder and download
```{r}
sub_folder_name<-"UCDP"
download_create_folder_and_unzip(desktop_path,
                           sub_folder_name,
                           "https://ucdp.uu.se/downloads/extsup/ESD/ucdp-esd-ty-181.zip")
```

#### Import
```{r}
file_path<-file.path(desktop_path,main_folder_name, sub_folder_name, "ucdp-esd-ty-181.dta")
## import  dataset
ESD<- haven::read_dta(file_path)
```

#### Reshaping dataset - calculating total amount of aid by type per recipient country per each year
```{r}
df_ESD<-ESD
##subset years
df_ESD<-subset(df_ESD, df_ESD$year>=1980)

## list var type of supports
all_vars <- names(df_ESD)
List <- all_vars[grep("^ext_", all_vars)]

## list vars of intrest
List2<-c("actor_name","year")
combined_list <- c(List, List2)

#select variables of interests
df_ESD<-df_ESD[c(combined_list)]

## keep only recipients that are governments
df_ESD <- subset(df_ESD, grepl("Government", actor_name))

## create iscode of recipient government
df_ESD <- df_ESD %>%
               mutate_at("actor_name", str_replace, "Government of ", "")

#assign ISO3
df_ESD$iso3c <- countrycode(df_ESD$actor_name, "country.name", "iso3c")

#drop iso3c NAs
df_ESD<-df_ESD[!is.na(df_ESD$iso3c), ]

## keep only support from state actors and coalitions
df_ESD<-subset(df_ESD, df_ESD$ext_nonstate==0)

## collapse at the level of the recipient country year
df_ESD_y<- df_ESD %>% 
  group_by(iso3c, year ) %>%
  summarize(N_funding = sum(ext_f),
            N_troops = sum(ext_x ),
            N_infra = sum(ext_y  ),
            N_weapons = sum(ext_w),
            N_logistics = sum(ext_m),
            N_training = sum(ext_t),
            N_intelligence = sum(ext_i),
            N_land = sum(ext_l),
            N_uknw = sum(ext_u))

## merge with Base
df_ESD_y= left_join(df_Base, df_ESD_y, by = c("year" = "year", "iso3c" = "iso3c"))

#list variables MDat
List<- colnames(df_ESD_y)[!colnames(df_ESD_y) %in% c("iso3c", "year")]

# assign 0s
df_ESD_y<-Nas_to_0(df_ESD_y,List)


# # Elements to drop
# elements_to_drop <- c("ext_id",
#                       "ext_name",
#                       "ext_nonstate",
#                       "ext_coalition",
#                       "ext_coalition_name",
#                       "ext_elements",
#                       "ext_bothsides",
#                       "ext_alleged",
#                       "ext_sum")

# Drop elements from the original list
#List_supp_type <- setdiff(List, elements_to_drop)

```
#### Reshaping dataset - calculating total amount of aid by type per each year
```{r}
df_ESD<-ESD
##subset years
df_ESD<-subset(df_ESD, df_ESD$year>=1980)


```

## Merge datasets
```{r}

```

## export final df
```{r}

```

