---
title: "DatasetCompiler"
author: "MNB"
date: "2/15/2024"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Libraries
```{r}
library(Hmisc)
library(data.table)

library(R.utils)
library(plyr)
library(dplyr)
library(tidyverse)
library(tidyr)
library(naniar)
library(geosphere)
library(zoo)
library(stringr)
library(tidytext)
library(rworldmap)
library(gridExtra)


library(classInt)
library(ggplot2)
library(devtools)
library(DT)
library(dvmisc)
library(ggpubr)
library(gtools)
library(foreign)
#library(GADMTools)
library(maps)


library(spdep)
library(lubridate)


library(WDI)
library(readxl)
library(haven)


library(reshape)

library(geojsonio)

library(countrycode)

library(roll)
```

# Remove lists 
```{r, include=FALSE}
## remove lists
rm(list=ls())
```

# Funtions 
```{r}
# calculate mode
mode <- function(v) {
  uniqv <- unique(v)
  uniqv[which.max(tabulate(match(v, uniqv)))]
}


# exclude
'%!in%' <- function(x,y)!('%in%'(x,y))

drop_columns <- function(data, columns_to_drop) {
  data <- data[, names(data) %!in% columns_to_drop, drop = FALSE]
  return(data)
}


## drop NAs from column
Drop_NA <- function(dataset, col_name){
  col_name <- enquo(col_name)
  dataset %>%
    drop_na((!!col_name)) %>%
    as.data.frame()
}

## create 1 and 2 period lags (grouping by a variable)
Lag_12 <- function(dataset,col_name,x){
  {
    col_name <- enquo(col_name)
    dataset %>%
      group_by(!!col_name) %>%
      mutate(across(all_of(x),
                    .fns = ~ lag(.,1),
                    .names = paste0("{.col}_lag_",1)))%>%
      mutate(across(all_of(x),
                    .fns = ~ lag(.,2),
                    .names = paste0("{.col}_lag_",2)))
    
  } 
}

## create 1 and 2 period lags 
Lag_12_ngby <- function(dataset,x){
  {
    dataset %>%
      mutate(across(all_of(x),
                    .fns = ~ lag(.,1),
                    .names = paste0("{.col}_lag_",1)))%>%
      mutate(across(all_of(x),
                    .fns = ~ lag(.,2),
                    .names = paste0("{.col}_lag_",2)))
    
  } 
}

## assign 0 to NAs
Nas_to_0 <- function(dataset, x) {
  
  dataset %>% mutate_at(all_of(x), ~replace(., is.na(.), 0))
  
}


download_and_create_folder <- function(file_name, desktop_path, folder_name, url) {
  
  # Combine the desktop path with the folder name
  folder_path <- file.path(desktop_path,main_folder_name, folder_name)
  
  
  # Check if the folder exists
  if (!file.exists(folder_path)) {
    # If the folder doesn't exist, create it
    dir.create(folder_path)
    cat("Folder", folder_path, "created.\n")
  } else {
    # If the folder already exists, do nothing
    cat("Folder", folder_path, "already exists.\n")
  }
  
  # Specify the file path where you want to save the downloaded file
  file_path <- paste0(folder_path, "/", file_name)
  
  # Download the file
  download.file(url, file_path, mode = "wb")
}




download_create_folder_and_unzip <- function(desktop_path, folder_name, url) {
  
  # Combine the desktop path with the folder name
  folder_path <- file.path(desktop_path,main_folder_name, folder_name)
  
  
  # Check if the folder exists
  if (!file.exists(folder_path)) {
    # If the folder doesn't exist, create it
    dir.create(folder_path)
    cat("Folder", folder_path, "created.\n")
  } else {
    # If the folder already exists, do nothing
    cat("Folder", folder_path, "already exists.\n")
  }
  
  # Specify the file path where you want to save the downloaded file
  file_path <- folder_path
  
  # Download the file
  download.file(url, destfile = "temp.zip", mode = "wb")
  
  # Unzip the downloaded file
  unzip("temp.zip", exdir = file_path)
  
  # Delete the temporary zip file
  file.remove("temp.zip")
}

```


# Setting directory for datasets' folders
```{r}
desktop_path <- file.path("C:", "Users", "marco", "Desktop")
#desktop_path <- file.path("C:", "Users","krogers","Documents")
```


# Set main folder name
```{r}
# Define the name of the folder to check/create
main_folder_name <- "DFGlobalLab"
#main_folder_name <- "data"
```

# Creating folder for datasets
```{r}

# Combine the desktop path with the folder name
folder_path <- file.path(desktop_path, main_folder_name)

# Check if the folder exists
if (!file.exists(folder_path)) {
  # If the folder doesn't exist, create it
  dir.create(folder_path)
  cat("Folder", main_folder_name, "created on the desktop.\n")
} else {
  # If the folder already exists, do nothing
  cat("Folder", main_folder_name, "already exists on the desktop.\n")
}
```

# Importing and reshaping Dfs

### Polity 2
#### Set subfolder name
```{r}
sub_folder_name<-"polity2"
```

#### Create folder and download
```{r}
download_and_create_folder("p5v2018.xls",
                           desktop_path,
                           sub_folder_name,
                           "http://www.systemicpeace.org/inscr/p5v2018.xls")
```

#### Import
```{r}
file_path<-file.path(desktop_path,main_folder_name, sub_folder_name, "p5v2018.xls")
## import  dataset
Polity2<- read_excel(file_path)
```

# Create bases - at year and month levels
```{r}
df_Polity2<-Polity2

# Create base at year level
## subset years of interests
df_Polity2<-subset(df_Polity2, df_Polity2$year>1980 & Polity2$year<2020)

# Rename countries
  replacements <- c(
    "Czechoslovakia" = "Czech Republic (the)",
    "Serbia Montenegro" = "Serbia",
    "Yugoslavia" = "Serbia"
  )
  df_Polity2$country <- ifelse(df_Polity2$country %in% names(replacements), replacements[df_Polity2$country], df_Polity2$country)

## assign ISO3C
df_Polity2$iso3c <- countrycode(df_Polity2$country, "country.name", "iso3c")

## subset only columns of interest
df_Base_Y<-df_Polity2[c("country",
                        "iso3c",
                        "year")]

# Complete panel
df_Base_Y<-df_Base_Y %>%
  complete(iso3c,year=c(1981:2021)) %>%
  group_by(iso3c) %>% fill(country) %>%
  ungroup()

## drop iso3c NA
df_Base_Y<-Drop_NA(df_Base_Y, iso3c)

#drop duplicates (usual yuogoslavia and soviet union "problem" with name change to serbia and russia)
df_Base_Y<-df_Base_Y %>% 
                distinct(year, iso3c , .keep_all = TRUE)

## correct names
df_Base_Y<-janitor::clean_names(df_Base_Y)

# Create base at month level
## set list of countries
Countries<-as.data.frame(unique(df_Base_Y$country))
names(Countries)[1] <- "country"
Countries$Dummy<-1
## assign ISO3C
Countries$iso3c <- countrycode(Countries$country, "country.name", "iso3c")
## set list of months
Date<-as.data.frame(seq(as.Date("1980-1-1"), as.Date("2021-12-31"), by = "month"))
names(Date)[1] <- "Date.month"
Date$Dummy<-1
Date$Date.month<-as.yearmon(Date$Date.month)
## create base
df_Base_YM<-left_join(Countries,Date)
## drop dummy
List<-c("Dummy")
df_Base_YM<-drop_columns(df_Base_YM,List)
## create year variable
df_Base_YM$year <- as.integer(c((substr(( c(df_Base_YM$Date.month)), 5, 8))))

## correct names
df_Base_YM<-janitor::clean_names(df_Base_YM)

```

### EMDAT
#### Link df: https://www.emdat.be/database (for EMdat there is no API and a format to download. thus I sugest to manually create a subfolder named EMDAT in the folder DFGlobalLab and save there the EMdat dataset manually downloaded from here: https://public.emdat.be/data. on February 17th I downloaded the dataset selecting both natural and technological disasters in the form "classification", and selecting all the continets in the from "countries". For the time period I selected 1980 - 2020. I transofremd the file in a STATA dataset and uploaded the file on github under the name emdat) 
#### Set subfolder name
```{r}
sub_folder_name<-"EMDAT"
```

#### Importing dataset
```{r}
file_path<-file.path(desktop_path,main_folder_name, sub_folder_name, "emdat.dta")
## import  dataset
EMDAT<- haven::read_dta(file_path)
```

#### Reshaping EMDAT
##### Adjusting names of countries, setting variables etc.
```{r}
# Function to process dataset
process_EmDat_1 <- function(data, min_affected) {
  # Subset years
  data <- subset(data, StartYear >= 1980)
  
  # Subset only big disasters
  data <- subset(data, NoAffected > min_affected)
  
  # Drop technological disasters
  data <- subset(data, DisasterGroup == "Natural")
  
  # Select variables of interest
  data <- data[c("DisNo", "StartYear", "EndYear", "StartMonth", "EndMonth",
                 "DisasterGroup", "DisasterSubgroup", "DisasterType",
                 "DisasterSubtype", "ISO", "Country")]
  
  # Rename variables
  names(data)[names(data) == "Year"] <- "year"
  names(data)[names(data) == "Country"] <- "country_Emdat"
  
  # Drop events without date
  data <- data[complete.cases(data$StartMonth, data$EndMonth), ]
  
  # Create date variables
  data$Date.start <- as.Date(paste0(data$StartYear, "-", data$StartMonth, "-01"))
  data$Date.end <- as.Date(paste0(data$EndYear, "-", data$EndMonth, "-01"))
  
  # Rename countries
  replacements <- c(
    "Czechoslovakia" = "Czech Republic (the)",
    "Germany Fed Rep" = "Germany",
    "Korea (the Republic of)" = "Korea South",
    "Korea (the Democratic People's Republic of)" = "Korea North",
    "Serbia Montenegro" = "Serbia",
    "Yugoslavia" = "Serbia"
  )
  data$country_Emdat <- ifelse(data$country_Emdat %in% names(replacements), replacements[data$country_Emdat], data$country_Emdat)
  
  # Create ISO codes
  data$iso3c <- countrycode(data$country_Emdat, "country.name", "iso3c")
  
  # Drop NA ISO codes
  data <- data[complete.cases(data$iso3c), ]
  
  # Subset variables
  data <- data[c("DisNo", "iso3c", "DisasterSubgroup", "Date.start", "Date.end")]
  
  # Sort dataset
  data <- data[order(data$iso3c, data$Date.start), ]
  
  return(data)
}

# Apply function for different thresholds
EM_dat_1k <- process_EmDat_1(EMDAT, 1000)
EM_dat_5k <- process_EmDat_1(EMDAT, 5000)
EM_dat_50k <- process_EmDat_1(EMDAT, 50000)
```

##### Getting it in a country-year-month panel format
```{r}

process_EmDat_2 <- function(df, df_basey) {
# Reshape dataset
df <- df %>%
  group_by(iso3c, DisNo, DisasterSubgroup) %>%
  summarise(date = list(seq(floor_date(min(Date.start), unit = "month"),
                            floor_date(max(Date.end), unit = "month"),
                            by = "month"))) %>%
  unnest(cols = c(date))

# Sort dataframe
df <- df[order(df$iso3c, df$date), ]

# Create dummy for count
df$count <- 1

# Count events
df <- df %>%
  group_by(iso3c, DisasterSubgroup, date) %>%
  summarise(count = sum(count))

# Reshape
df <- dcast(df, date + iso3c ~ DisasterSubgroup)

# Merge with vector dates countries
df$Date_month <- as.yearmon(df$date)
df <- left_join(df_basey, df, by = c("date_month" = "Date_month", "iso3c" = "iso3c"))

# List variables
List <- setdiff(names(df), c("country", "year", "iso3c", "count", "date_month", "date"))

# Assign 0s
df <- df %>%
  mutate(across(all_of(List), ~ replace_na(., 0)))

# Drop date
df <- select(df, -date)

# Create variable year
df$year <- as.double(substr(df$date_month, 5, 9))


# Create dummy variables
df[List] <- lapply(df[List], function(x) as.integer(x > 0))
colnames(df)[colnames(df) %in% List] <- paste0(colnames(df)[colnames(df) %in% List], "_dummy")

# List variables
List <- grep("_dummy$", names(df), value = TRUE)

# Create lags
df <- Lag_12(df, iso3c, List)

# Clean names
df <- janitor::clean_names(df)

  
  return(df)
}

# Process each dataset
EM_dat_1k_processed_2 <- process_EmDat_2(EM_dat_1k, df_Base_YM)
EM_dat_5k_processed_2 <- process_EmDat_2(EM_dat_5k, df_Base_YM)
EM_dat_50k_processed_2 <- process_EmDat_2(EM_dat_50k, df_Base_YM)

```

##### Getting it in a country-year panel format
```{r}
process_EmDat_3 <- function(df, df_basey) {
  df <- df %>%
    group_by(iso3c, year) %>%
    summarize(
      across(ends_with("_dummy"), sum)
    )
  
  # create dummy variables
  List <- setdiff(names(df), c("iso3c", "year"))
  for (variable in List) {
    new_name <- sub("_n_m$", "_dummy", variable)
    df[[new_name]] <- ifelse(df[[variable]] == 0, 0, 1)
  }
  
  # Merge with Base
  df <- left_join(df_basey, df, by = c("year", "iso3c"))
  
  # Assign 0s
  df <- df %>%
    mutate(across(List, ~ replace_na(., 0)))
  
  # Lag 12
  df <- Lag_12(df, iso3c, List)
  
  # Clean names
  df <-  janitor::clean_names(df)
  
  return(df)
}

# Process each dataset
EM_dat_1k_processed_3 <- process_EmDat_3(EM_dat_1k_processed_2, df_Base_Y)
EM_dat_5k_processed_3 <- process_EmDat_3(EM_dat_5k_processed_2, df_Base_Y)
EM_dat_50k_processed_3 <- process_EmDat_3(EM_dat_50k_processed_2, df_Base_Y)
```

### UCDP GED
#### Link df: https://ucdp.uu.se/downloads/index.html#ged_global
#### Set subfldder name
```{r}
sub_folder_name<-"UCDP"
```

#### Create folder and download
```{r}
download_create_folder_and_unzip(desktop_path,
                           sub_folder_name,
                           "https://ucdp.uu.se/downloads/ged/ged231-csv.zip")
```

#### Import
```{r}
file_path<-file.path(desktop_path,main_folder_name, sub_folder_name, "GEDEvent_v23_1.csv")
#file_path<-file.path("~/Documents/data/UCDP/GEDEvent_v23_1.csv")
## import  dataset
UCDP_GED<- read.csv(file_path)
```


#### Reshaping UCDP GED
##### Adjusting names of countries, setting variables etc.
```{r}
df_UCDP_GED<-UCDP_GED

#assign ISO3
df_UCDP_GED$iso3c <- countrycode(df_UCDP_GED$country, "country.name", "iso3c",
                                 custom_match = c("Yemen (North Yemen)" = "YEM"))

#create year month date
            df_UCDP_GED$month <- c((substr(( c(df_UCDP_GED$date_start)), 6, 7)))
            df_UCDP_GED$day<- c((substr(( c(df_UCDP_GED$date_start)), 9, 10)))

            df_UCDP_GED$day.month.year <- as.character(paste0(df_UCDP_GED$month,
                                                          "/",
                                                          df_UCDP_GED$day,
                                                          "/",
                                                          df_UCDP_GED$year))

            df_UCDP_GED$month.year <- as.character(paste0(df_UCDP_GED$year,
                                                      "-",
                                                      df_UCDP_GED$month))

            df_UCDP_GED$Date<-as.Date(df_UCDP_GED$day.month.year, format = "%m/%d/%Y")
            df_UCDP_GED$date_month<-as.yearmon(df_UCDP_GED$month.year)
```

##### Getting it in a country-year-month panel format
```{r}
# aggregate at country year month level
df_UCDP_GED_m<- df_UCDP_GED %>% 
  group_by(iso3c, year, month, date_month, type_of_violence) %>%
  summarize(n_fatalities = sum(best))


# reshape
df_UCDP_GED_m<-reshape2::dcast(df_UCDP_GED_m, year+date_month+iso3c~`type_of_violence`)

## merge with Base
df_UCDP_GED_m= left_join(df_Base_YM, df_UCDP_GED_m, by = c("date_month" = "date_month","year" = "year", "iso3c" = "iso3c"))

# list variables ged
List<- colnames(df_UCDP_GED_m)[colnames(df_UCDP_GED_m) %!in% c("iso3c",
                                                               "year",
                                                               "country",
                                                               "date_month")]

# assign 0s
df_UCDP_GED_m<-Nas_to_0(df_UCDP_GED_m,List)

#rename variables
names(df_UCDP_GED_m)[names(df_UCDP_GED_m) == "1"] <- "StateBased_conf_fat"
names(df_UCDP_GED_m)[names(df_UCDP_GED_m) == "2"] <- "NonState_conf_fat"
names(df_UCDP_GED_m)[names(df_UCDP_GED_m) == "3"] <- "OneSided_fat"

# create dummy variable conflict ongoin (at least 25 battle-related fatalities in a given year in a given country)
df_UCDP_GED_m$dummy_conf<-ifelse(df_UCDP_GED_m$StateBased_conf_fat>24,1,0)

# list variables ged
List<- colnames(df_UCDP_GED_m)[colnames(df_UCDP_GED_m) %!in% c("iso3c",
                                                               "year",
                                                               "country",
                                                               "date_month")]

# Replace values with NA for years before 1989
df_UCDP_GED_m[df_UCDP_GED_m$year < 1989, List] <- NA


## create lags
df_UCDP_GED_m<-Lag_12(df_UCDP_GED_m, iso3c, List)

```

##### Getting it in a country-year panel format
```{r}
## aggregate at country iso3c level
df_UCDP_GED_Y<- df_UCDP_GED %>% 
  group_by(iso3c, year, type_of_violence) %>%
  summarize(n_fatalities = sum(best))

#reshape
df_UCDP_GED_Y<-reshape2::dcast(df_UCDP_GED_Y, year+iso3c~`type_of_violence`)

## merge with Base
df_UCDP_GED_Y= left_join(df_Base_Y, df_UCDP_GED_Y, by = c("year" = "year", "iso3c" = "iso3c"))

#list variables ged
List<- colnames(df_UCDP_GED_Y)[colnames(df_UCDP_GED_Y) %!in% c("iso3c", "year")]

# assign 0s
df_UCDP_GED_Y<-Nas_to_0(df_UCDP_GED_Y,List)

#rename variables
names(df_UCDP_GED_Y)[names(df_UCDP_GED_Y) == "1"] <- "StateBased_conf_fat"
names(df_UCDP_GED_Y)[names(df_UCDP_GED_Y) == "2"] <- "NonState_conf_fat"
names(df_UCDP_GED_Y)[names(df_UCDP_GED_Y) == "3"] <- "OneSided_fat"

## create dummy variable conflict ongoin (at least 25 battle-related fatalities in a given year in a given country)
df_UCDP_GED_Y$dummy_conf<-ifelse(df_UCDP_GED_Y$StateBased_conf_fat>24,1,0)

#list variables ged
List<- colnames(df_UCDP_GED_Y)[colnames(df_UCDP_GED_Y) %!in% c("iso3c", "year")]

## create lags
df_UCDP_GED_Y<-Lag_12(df_UCDP_GED_Y, iso3c, List)
```

### ICEWS
#### Link df: https://dataverse.harvard.edu/dataverse/icews?q=&types=files&sort=dateSort&order=desc&page=5 (in the Dropboy folder you find in the folder ICWES and subfoder years all the original .tab files of events from the dataset. just copy them in the local foder that is created with the following code)

#### Set subfolder name
```{r}
sub_folder_name <- "ICEWS"
```

#### Creating folder for ICEWS
```{r}
folder_path <- file.path(desktop_path,main_folder_name, sub_folder_name)

# Check if folder already exists
if (!file.exists(folder_path)) {
  # If not, create the folder
  dir.create(folder_path)
  print(paste("Folder", folder_path, "created."))
} else {
  print(paste("Folder", folder_path, "already exists."))
}
```

#### Importing ICEWS from row data
```{r}
#import datasets
ldf <- list() # creates a list

for (k in 1995:2022){

 year<-paste0("",k,"")
 #File<-paste0("G:/My Drive/Research/CSTM/ICEWS/years/events.",year,".tab")
 File<-paste0("C:/Users/krogers/Documents/data/ICEWS/events.",year,".tab")
 df<- read.delim(File, header = TRUE, quote = "")
 df<-df[c(1:11)]
 names(df)[1] <- "event_id"
 names(df)[2] <- "event_date"
 names(df)[3] <- "source_name"
 names(df)[4] <- "source_sector"
 names(df)[5] <- "source_country"
 names(df)[6] <- "event_text"
 names(df)[7] <- "cameo_code"
 names(df)[8] <- "intensity"
 names(df)[9] <- "target_name"
 names(df)[10] <- "target_sectors"
 names(df)[11] <- "target_country"

 ldf[[k]]<-df

}

#bind datasets
df_ICWES <- do.call(rbind, ldf)
# drop list
rm(ldf)

#correct entries (f*ck 2015,2016 datastes)
## Define the columns to apply the transformation to
List <- c("source_name", "source_sector", "source_country", "target_name", "target_country")

## Apply gsub function to selected columns using mutate_at
df_ICWES <- df_ICWES %>% 
  mutate_at(vars(List), ~gsub("[^\\p{L}0-9\\s]", "", ., perl = TRUE))

```

#### Saving ICEWS events as a full rds file to save time when loading it
```{r}
URL_df<-paste0(folder_path,"/", "df_ICWES.rds")
# saving icews df
saveRDS(df_ICWES, URL_df)

```

#### Importing ICEWS from the rds. file. this helps to skip the "Importing ICEWS from row data" block of code
```{r}
URL_df<-paste0(folder_path,"/", "df_ICWES.rds")
#URL_df<-paste0(folder_path,"/", "icews.rds")

# importing icews df
df_ICWES <- readRDS(URL_df)

```

#### Reshaping ICEWS 
##### Adjusting names of countries, setting variables etc.
```{r}
#create dummy event
df_ICWES$Event_ICEWS<-1
#set date
df_ICWES$Date.month<-as.yearmon(df_ICWES$event_date)

## create year
df_ICWES$year <- as.integer(c((substr(( c(df_ICWES$Date.month)), 5, 8))))

#set ISO3C
df_ICWES$iso3c_target <- countrycode(df_ICWES$target_country, "country.name", "iso3c")
df_ICWES$iso3c_source <- countrycode(df_ICWES$source_country, "country.name", "iso3c")
#drop NA
df_ICWES<-Drop_NA(df_ICWES, iso3c_target)
df_ICWES<-Drop_NA(df_ICWES, iso3c_source)

# keep only state based events
## create dummy if sender is government and receiver is government
df_ICWES$gov_sender<-ifelse(grepl("Govern", df_ICWES$source_sector),1,0)
df_ICWES$gov_target<-ifelse(grepl("Govern", df_ICWES$target_sectors),1,0)
```

##### Subsetting events of interest
```{r}
# subset dataset 
## subset governative interactions
df_ICWES_g2g<-subset(df_ICWES, df_ICWES$gov_sender==1 &
                               df_ICWES$gov_target==1)

# keep only expressions between two different countries
## create dummy variable to identfy cross-country expressions
df_ICWES_g2g$inter_gov <-0
df_ICWES_g2g$inter_gov[df_ICWES_g2g$iso3c_source!=df_ICWES_g2g$iso3c_target] <-1  
## keeping only inter_gov expressions
df_ICWES_g2g<-subset(df_ICWES_g2g, df_ICWES_g2g$inter_gov==1)

# keep only expressions to cooperate
## Define the columns to apply the transformation to
List <- c("event_text")

## Apply gsub function to selected columns using mutate_at
df_ICWES_g2g <- df_ICWES_g2g %>% 
  mutate_at(vars(List), ~gsub("[^\\p{L}0-9\\s]", "", ., perl = TRUE))

## create var =1 if event is an expression of intent or else
df_ICWES_g2g <- df_ICWES_g2g %>%
  mutate(
    express_int = as.integer(grepl("Express intent to", event_text)),
    engage_symb = as.integer(grepl("Engage in symbolic act", event_text)),
    make_emp = as.integer(grepl("Make empathetic comment", event_text)),
    express_accord = as.integer(grepl("Express accord", event_text))
  )

## keep only expressions of intent to cooperate
df_ICWES_g2g<-subset(df_ICWES_g2g, df_ICWES_g2g$express_int==1 |
                       df_ICWES_g2g$engage_symb==1 |
                       df_ICWES_g2g$make_emp==1 |
                       df_ICWES_g2g$express_accord==1)



# drop inter gov expressions of intent to cooperate clearly unrelated to humanitarian aid
## List of strings to drop
List <- c("Express intent to cooperate militarily",
          "Express intent to cooperate on judicial matters",
          "Express intent to institute political reform",
          "Express intent to meet or negotiate",
          "Express intent to provide military aid",
          "Express intent to release persons or property",
          "Express intent to ease economic sanctions boycott or embargo",
          "Express intent to yield",
          "Express intent to change leadership",
          "Express intent to cooperate on intelligence",
          "Express intent to deescalate military engagement",
          "Express intent to mediate",
          "Express intent to provide military protection or peacekeeping",
          "Express intent to settle dispute",
          "Express intent to ease administrative sanctions",
          "Express intent to accept mediation")

## Dropping observations containing strings in the list
df_ICWES_g2g <- subset(df_ICWES_g2g, (event_text %!in% List))


# drop useless vars
List<-c("gov_sender",
        "gov_target",
        "express_int",
        "inter_gov")
df_ICWES_g2g<-drop_columns(df_ICWES_g2g,List)

## correct names
df_ICWES_g2g<-janitor::clean_names(df_ICWES_g2g)
```

##### Merge with emdat country month level dataset in order to identify declarations 
```{r}
df_ICWES_g2g_dis1k= left_join(df_ICWES_g2g, EM_dat_1k_processed_2, by = c("date_month" = "date_month", "iso3c_target" = "iso3c", "year"="year"))
df_ICWES_g2g_dis5k= left_join(df_ICWES_g2g, EM_dat_5k_processed_2, by = c("date_month" = "date_month", "iso3c_target" = "iso3c", "year"="year"))
df_ICWES_g2g_dis50k= left_join(df_ICWES_g2g, EM_dat_50k_processed_2, by = c("date_month" = "date_month", "iso3c_target" = "iso3c", "year"="year"))


process_ICEWS_1 <- function(df) {
  # List of dummy variables
  dummy_vars <- grep("dummy", names(df), value = TRUE)
  
  # Create the 'disaster' variable
  df$disaster <- as.numeric(rowSums(df[dummy_vars]) > 0)
  
  # Subset to keep only observations occurred during a disaster or at max 2 months by it
  df <- subset(df, disaster == 1)
  
  return(df)
}

# Process each dataset
df_ICWES_g2g_dis1k <- process_ICEWS_1(df_ICWES_g2g_dis1k)
df_ICWES_g2g_dis5k <- process_ICEWS_1(df_ICWES_g2g_dis5k)
df_ICWES_g2g_dis50k <- process_ICEWS_1(df_ICWES_g2g_dis50k)

```

##### Remove from environment df_ICWES to save memory
```{r}
rm(df_ICWES)
```

##### Calculating number of countries sending verbal support during and after natural disaster
```{r}

process_ICEWS_2 <- function(df) {
  # count speakers
  ## aggregate at country year level
  df<- df %>% 
    dplyr::rename(iso3c=iso3c_target) %>%
    group_by(iso3c, year) %>%
    summarize(NormAgr = n_distinct(source_country))
  
    #list variables 
  List<- colnames(df)[colnames(df) %!in% c("iso3c", "year")]
  
  # assign 0s
  df<-Nas_to_0(df,List)
  
  return(df)

  }

df_ICWES_dis1k_y<-process_ICEWS_2(df_ICWES_g2g_dis1k)
df_ICWES_dis5k_y<-process_ICEWS_2(df_ICWES_g2g_dis5k)
df_ICWES_dis50k_y<-process_ICEWS_2(df_ICWES_g2g_dis50k)

```

##### Merge ICEWS counts with panel countries that experienced disaster
```{r}

# Function to summarize data by year
process_ICEWS_4 <- function(df_EMdat, df_ICEWS_input ) {

# Identify columns containing the string "lag"
lag_columns <- grep("lag", names(df_EMdat), value = TRUE)

# Drop columns containing the string "lag"
df <- df_EMdat[, !names(df_EMdat) %in% lag_columns]

# List of dummy variables
  dummy_vars <- grep("dummy", names(df), value = TRUE)
  
# Create the 'disaster' variable
  df$disaster <- as.numeric(rowSums(df[dummy_vars]) > 0)

# keep only disaster years
  df<-subset(df,df$disaster>0)
  
  # drop useless vars
List<-dummy_vars

df<-drop_columns(df,List)
  
## merge dataframes
df_ICEWS_EMDAT= left_join(df, df_ICEWS_input, by = c("iso3c" = "iso3c", "year"="year"))
  
  #list variables 
  List<- c("NormAgr")
  
# Assign 0s
  df_ICEWS_EMDAT <- df_ICEWS_EMDAT %>%
    mutate(across(List, ~ replace_na(., 0)))

# Delete years before 1995
df_ICEWS_EMDAT<-df_ICEWS_EMDAT[df_ICEWS_EMDAT$year > 1994,]
  
  
  return(df_ICEWS_EMDAT)
}

df_ICEWS_EMDAT_1ky<-process_ICEWS_4(EM_dat_1k_processed_3,df_ICWES_dis1k_y)  
df_ICEWS_EMDAT_5ky<-process_ICEWS_4(EM_dat_5k_processed_3,df_ICWES_dis5k_y)
df_ICEWS_EMDAT_50ky<-process_ICEWS_4(EM_dat_50k_processed_3,df_ICWES_dis50k_y)


```


##### Calculating average number of countries sending verbal support during and after natural disaster per year
```{r}

#Function to calculate the mean of current and previous years
process_ICEWS_3 <- function(df_input) {

    means <- c()
  
 for (year in unique(df_input$year)) {
    # Calculate mean for the current year and all preceding years
    value <- mean(df_input$NormAgr[df_input$year <= year])
    
    means <- c(means, value)
 }
  
 # Create a year-level data frame
 means_df <- data.frame(year = unique(df_input$year), year_mean_NormAgr = means)
  
 return(means_df)
}

# Summarize each dataset
df_ICWES_dis1k_y_small <- process_ICEWS_3(df_ICEWS_EMDAT_1ky)
df_ICWES_dis5k_y_small <- process_ICEWS_3(df_ICEWS_EMDAT_5ky)
df_ICWES_dis50k_y_small <- process_ICEWS_3(df_ICEWS_EMDAT_50ky)


```

##### Calculating wich countries received more normative agreement than the average
```{r}

# Function to summarize data by year
process_ICEWS_4 <- function(df_input,df_input_2) {
  
  ## merge with emdat country month level dataset in order to identify declarations 
df_input= left_join(df_input_2, df_input, by = c("year"="year"))

df_input$dummy_agreement<-ifelse(df_input$NormAgr> df_input$year_mean_NormAgr,1,0)


# keep var of interest
df_output <- df_input[ , names(df_input) %in% c("iso3c",
                                                "year",
                                                "dummy_agreement",
                                                "year_mean_NormAgr",
                                                "NormAgr")]  
  return(df_output)
}




# Summarize each dataset
df_ICWES_dis1k_y <- process_ICEWS_4(df_ICWES_dis1k_y_small,df_ICWES_dis1k_y)
df_ICWES_dis5k_y <- process_ICEWS_4(df_ICWES_dis5k_y_small,df_ICWES_dis5k_y)
df_ICWES_dis50k_y <- process_ICEWS_4(df_ICWES_dis50k_y_small,df_ICWES_dis50k_y)


```

##### Calculating number of verbal support a country receives during conflict per month
```{r}

```

### AidData
#### Link df: https://www.aiddata.org/data/aiddata-core-research-release-level-1-v3-0
#### Create folder and download
#### Set name folder
```{r}
sub_folder_name<-"Aidata"
```
#### Create folder and download
```{r}
download_create_folder_and_unzip(desktop_path,
                           sub_folder_name,
                           "https://github.com/AidData-WM/public_datasets/releases/download/v3.0/AidDataCore_ResearchRelease_Level1_v3.0.zip")
```

#### Import
```{r}
file_path<-file.path(desktop_path,main_folder_name, sub_folder_name, "AidDataCoreDonorRecipientYearPurpose_ResearchRelease_Level1_v3.0.csv")
## import  dataset
Aiddata<- read.csv(file_path)
```


#### Reshaping AidData 
##### Calculating total amount of aid
```{r}
df_Aiddata<-Aiddata

## aggregate at country recipient level
df_Aiddata<- df_Aiddata %>% 
  group_by(recipient, year ) %>%
  summarize(AidData_tot_commit = sum(commitment_amount_usd_constant_sum))

#change names
df_Aiddata$recipient[df_Aiddata$recipient=="Yugoslavia"] <- "Serbia"
df_Aiddata$recipient[df_Aiddata$recipient=="Serbia and Montenegro"] <- "Serbia"
df_Aiddata$recipient[df_Aiddata$recipient=="Soviet Union"] <- "Russia"

#assign ISO3
df_Aiddata$iso3c <- countrycode(df_Aiddata$recipient, "country.name", "iso3c")

#drop iso3c NAs
df_Aiddata<-df_Aiddata[!is.na(df_Aiddata$iso3c), ]

#create Aiddata country date dataset
df_Aiddata_C<-as.data.frame(unique(df_Aiddata$iso3c))
names(df_Aiddata_C)[1] <- "iso3c"
df_Aiddata_C$Dummy<-1
Date_Y_AidData<-as.data.frame(seq(as.Date("1970-1-1"), as.Date("2013-12-31"), by = "year"))
names(Date_Y_AidData)[1] <- "year"
Date_Y_AidData$Dummy<-1
Date_Y_AidData$year<-as.double((substr(( c(Date_Y_AidData$year)), 1, 4)))
df_Aiddata_CY<-left_join(df_Aiddata_C,Date_Y_AidData)

# merge with with aid data country year vector
df_Aiddata<-left_join(df_Aiddata_CY,df_Aiddata, by = c("iso3c" = "iso3c","year"="year"))

#drop duplicates (usual yuogoslavia and soviet union "problem" with name change to serbia and russia)
df_Aiddata<-df_Aiddata %>% 
                distinct(year, iso3c , .keep_all = TRUE)

## merge with world Bank Population
WorldBank_pop <- WDI(
  country = "all",
  indicator = c("Pop_tot"="SP.POP.TOTL"),
  start = 1960,
  end = 2020,
  extra = TRUE,
  cache = NULL,
  latest = NULL,
  language = "en"
)

## assign ISO3
names(WorldBank_pop)[names(WorldBank_pop) == "country"] <- "country_wb"
WorldBank_pop$iso3c <- countrycode(WorldBank_pop$country_wb, "country.name", "iso3c")

# merge with aid data 
df_Aiddata<-left_join(df_Aiddata,WorldBank_pop)

##assign 0s and NAs
List<-c("AidData_tot_commit")
df_Aiddata<-Nas_to_0(df_Aiddata, List)

#divide by population
df_Aiddata$AidData_tot_commit_per_cap<-df_Aiddata$AidData_tot_commit/df_Aiddata$Pop_tot

# keep var of interest
df_Aiddata <- df_Aiddata[ , !names(df_Aiddata) %in% c("Dummy",
                                                      "iso2c",
                                                      "country_wb",
                                                      "Pop_tot",
                                                      "region",
                                                      "capital",
                                                      "longitude",
                                                      "latitude",
                                                      "income",
                                                      "lending",
                                                      "recipient")]
## merge with Base
df_Aiddata= left_join(df_Base_Y, df_Aiddata, by = c("year" = "year", "iso3c" = "iso3c"))

#list variables aidata
List<- colnames(df_Aiddata)[!colnames(df_Aiddata) %in% c("iso3c", "year")]

# assign 0s
df_Aiddata<-Nas_to_0(df_Aiddata,List)

# list variables aidata
List<- colnames(df_Aiddata)[colnames(df_Aiddata) %in% c("AidData_tot_commit",
                                                         "AidData_tot_commit_per_cap")]

# Replace values with NA for years after 2013
df_Aiddata[df_Aiddata$year > 2013, List] <- NA

```

##### Calculating total amount of aid by sector per recipient country per each year
```{r}
#load dataset
df_Aiddata_sectoral<-Aiddata

#create schort code
df_Aiddata_sectoral$Short_code<-c((substr(( c(df_Aiddata_sectoral$coalesced_purpose_code)), 1, 2)))

## rename codes
# Define replacements using a named vector
replacements <- c(
  "10" = "Social_Infra",
  "11" = "Education",
  "12" = "Health",
  "13" = "Population_Policies",
  "14" = "Water_Supply_Sanitation",
  "15" = "Gov_Civ_Soc",
  "16" = "Soc_Infra",
  "20" = "Eco_Infra",
  "21" = "Trans_Stor",
  "22" = "Comm",
  "23" = "Energy_Gen_Supp",
  "24" = "Banking",
  "25" = "Business",
  "30" = "Production Sectors",
  "31" = "Agri_For_Fish",
  "32" = "Ind_Min_Cons",
  "33" = "Trade_policy",
  "41" = "Env_Protection",
  "42" = "Women",
  "43" = "Other",
  "51" = "Budget_Support",
  "52" = "Food_Security",
  "53" = "Commodity_Assistance",
  "60" = "Debt",
  "70" = "Humanitarian_Aid",
  "72" = "Emergency_Response",
  "73" = "Reconstruction_Relief",
  "74" = "Disaster_Prevention",
  "91" = "Administrative_costs",
  "92" = "Support_NGO",
  "93" = "Refugees_Donor",
  "99" = "Unallocated"
)

# Apply replacements using named vector and %in% operator
df_Aiddata_sectoral$Short_code <- replacements[as.character(df_Aiddata_sectoral$Short_code)]

#change names countries
df_Aiddata_sectoral$recipient[df_Aiddata_sectoral$recipient=="Yugoslavia"] <- "Serbia"
df_Aiddata_sectoral$recipient[df_Aiddata_sectoral$recipient=="Serbia and Montenegro"] <- "Serbia"
df_Aiddata_sectoral$recipient[df_Aiddata_sectoral$recipient=="Soviet Union"] <- "Russia"

#assign ISO3
df_Aiddata_sectoral$iso3c <- countrycode(df_Aiddata_sectoral$recipient, "country.name", "iso3c")

#drop iso3c NAs
df_Aiddata_sectoral<-df_Aiddata_sectoral[!is.na(df_Aiddata_sectoral$iso3c), ]

## aggregate at country recipient purpose level
df_Aiddata_sectoral<- df_Aiddata_sectoral %>% 
  group_by(iso3c, year,Short_code ) %>%
  summarize(commitment_tot = sum(commitment_amount_usd_constant_sum))

# merge with with aid data country year vector
df_Aiddata_sectoral<-left_join(df_Aiddata_CY,df_Aiddata_sectoral, by = c("iso3c" = "iso3c","year"="year"))

## merge with wb
df_Aiddata_sectoral<-left_join(df_Aiddata_sectoral,WorldBank_pop, by = c("iso3c" = "iso3c","year"="year"))

#divide by population
df_Aiddata_sectoral$commit_per_cap<-df_Aiddata_sectoral$commitment_tot/df_Aiddata_sectoral$Pop_tot

# keep var of interest
df_Aiddata_sectoral <- df_Aiddata_sectoral[ ,  names(df_Aiddata_sectoral) %in% c("iso3c",
                                                                                  "year",
                                                                                  "Short_code",
                                                                                  "commit_per_cap",
                                                                                  "commitment_tot")]

#reshape
dcast1 <- reshape2::dcast(df_Aiddata_sectoral, iso3c + year ~ Short_code, value.var="commit_per_cap")
dcast2 <- reshape2::dcast(df_Aiddata_sectoral, iso3c + year ~ Short_code, value.var="commitment_tot")

#rename vars
cols_to_rename <- names(dcast1)[!(names(dcast1) %in% c("year", "iso3c"))]
dcast1 <- dcast1 %>%
  rename_with(~ paste0(., "_pc"), cols_to_rename)
dcast2 <- dcast2 %>%
  rename_with(~ paste0(., "_tot"), cols_to_rename)

# merge with dcast1 and dcast2 with aid data country year vector
df_Aiddata_sectoral<-left_join(df_Aiddata_CY, dcast1, by = c("iso3c" = "iso3c","year"="year"))
df_Aiddata_sectoral<-left_join(df_Aiddata_sectoral, dcast2, by = c("iso3c" = "iso3c","year"="year"))


#assign 0s
df_Aiddata_sectoral[is.na(df_Aiddata_sectoral)] = 0


#drop duplicates
df_Aiddata_sectoral<-df_Aiddata_sectoral %>% 
                distinct(year, iso3c , .keep_all = TRUE)

## merge with Base
df_Aiddata_sectoral= left_join(df_Base_Y, df_Aiddata_sectoral, by = c("year" = "year", "iso3c" = "iso3c"))

#list variables MDat
List<- colnames(df_Aiddata_sectoral)[!colnames(df_Aiddata_sectoral) %in% c("iso3c", "year")]

# assign 0s
df_Aiddata_sectoral<-Nas_to_0(df_Aiddata_sectoral,List)

# list variables aidata
List<- colnames(df_Aiddata_sectoral)[colnames(df_Aiddata_sectoral) %!in% c("country",
                                                         "iso3c",
                                                        "year")]

# Replace values with NA for years after 2013
df_Aiddata_sectoral[df_Aiddata_sectoral$year > 2013, List] <- NA

```

##### Calculating total amount of aid by sector commited worldwide per each year
```{r}
# calculate average
df_aid_sec<-df_Aiddata_sectoral

df_aid_sec$Hum_plus_ER_aid_tot<-df_aid_sec$Humanitarian_Aid_tot+df_aid_sec$Emergency_Response_tot
df_aid_sec$ln_Hum_plus_ER_aid_tot<-log(df_aid_sec$Humanitarian_Aid_tot+df_aid_sec$Emergency_Response_tot)

# keep vars of interest
df_aid_sec <- df_aid_sec[ , names(df_aid_sec) %in% c("iso3c",
                                                      "year",
                                                      "Hum_plus_ER_aid_tot",
                                                      "Humanitarian_Aid_tot",
                                                      "Emergency_Response_tot",
                                                      "ln_Hum_plus_ER_aid_tot")]

```

## Merge with emdat country year level dataset
```{r}

# Function to merge and find mean
process_AID <- function(df_EMdat, df_aid_input) {

# Identify columns containing the string "lag"
lag_columns <- grep("lag", names(df_EMdat), value = TRUE)

# Drop columns containing the string "lag"
df <- df_EMdat[, !names(df_EMdat) %in% lag_columns]

# List of dummy variables
  dummy_vars <- grep("dummy", names(df), value = TRUE)
  
# Create the 'disaster' variable
  df$disaster <- as.numeric(rowSums(df[dummy_vars]) > 0)

# keep only disaster years
  df<-subset(df,df$disaster>0)
  
  # drop useless vars
List<-dummy_vars

df<-drop_columns(df,List)
  
## merge dataframes
df_AID_EMDAT= left_join(df, df_aid_input, by = c("iso3c" = "iso3c", "year"="year"))
  
  #list variables 
  List<- c("Hum_plus_ER_aid_tot",
           "Humanitarian_Aid_tot",
           "Emergency_Response_tot",
           "ln_Hum_plus_ER_aid_tot")
  
# Assign 0s
  df_AID_EMDAT <- df_AID_EMDAT %>%
    mutate(across(List, ~ replace_na(., 0)))

# Delete years before 1995
df_AID_EMDAT<-df_AID_EMDAT[df_AID_EMDAT$year > 1994,]
  
  return(df_AID_EMDAT)
}

df_AID_EMDAT_1ky<-process_AID(EM_dat_1k_processed_3,df_aid_sec)  
df_AID_EMDAT_5ky<-process_AID(EM_dat_5k_processed_3,df_aid_sec)
df_AID_EMDAT_50ky<-process_AID(EM_dat_50k_processed_3,df_aid_sec)

```

##### Calculating average aid sent during natural disaster year
```{r}

#Function to calculate the mean of current and previous years
process_AID_2 <- function(df_input) {

    means <- c()
  
 for (year in unique(df_input$year)) {
    # Calculate mean for the current year and all preceding years
    value <- mean(df_input$Hum_plus_ER_aid_tot[df_input$year <= year])
    
    means <- c(means, value)
 }
  
 # Create a year-level data frame
 means_df <- data.frame(year = unique(df_input$year), year_mean_Hum_plus_ERaid = means)
  
 return(means_df)
}

# Summarize each dataset
df_AID_dis1k_y_small <- process_AID_2(df_AID_EMDAT_1ky)
df_AID_dis5k_y_small <- process_AID_2(df_AID_EMDAT_5ky)
df_AID_dis50k_y_small <- process_AID_2(df_AID_EMDAT_50ky)


```


##### Calculating wich countries received more sharing behaviour than the average
```{r}

# Function to summarize data by year
process_AID_3 <- function(df_input,df_input_2) {
  
## merge mean with country year aid sec dataset 
df_output= left_join(df_input_2, df_input, by = c("year"="year"))

df_output$dummy_Hplus_ERaid<-ifelse(df_output$Hum_plus_ER_aid_tot> df_output$year_mean_Hum_plus_ERaid,1,0)

  return(df_output)
}


# Summarize each dataset
df_AID_dis1k_y <- process_AID_3(df_AID_dis1k_y_small,df_AID_EMDAT_1ky)
df_AID_dis5k_y <- process_AID_3(df_AID_dis5k_y_small,df_AID_EMDAT_5ky)
df_AID_dis50k_y <- process_AID_3(df_AID_dis50k_y_small,df_AID_EMDAT_50ky)


```



## Add UNOCHA to 2019
```{r}
unocha<-read_excel("UNOCHA Funding received.xlsx")

unocha_long <-pivot_longer(unocha,2:11, names_to="year", values_to="Hum_plus_ER_aid_tot") %>%
  dplyr::rename(iso3c=`Country Code`) %>% 
  drop_na(Hum_plus_ER_aid_tot) %>%
  filter(year>2014) # from 2014

# Generate annual means
#   means <- c()
# for (year in unique(unocha_long$year)) {
#    value <- mean(unocha_long$Hum_plus_ER_aid_tot[unocha_long$year <= year])
#    means <- c(means, value)
# }  # Divide by ratio from analysis in compare-aid-data.R
# means_df <- data.frame(year = unique(unocha_long$year), year_mean_Hum_plus_ERaid = means/3.9)

# unocha_long <-unocha_long %>%
#   left_join(means_df)

unocha_long$year<-as.numeric(unocha_long$year)

#unocha_long$dummy_Hplus_ERaid<-ifelse(unocha_long$Hum_plus_ER_aid_tot>unocha_long$year_mean_Hum_plus_ERaid,1,0)

# Fill in blank variables for bind 
unocha_long <- unocha_long %>% 
  mutate(Emergency_Response_tot = NA,
         Humanitarian_Aid_tot= NA,
         ln_Hum_plus_ER_aid_tot= NA,
         year_mean_Hum_plus_ERaid = NA)
 
# Join to full aid data and fill mean threshold from 2013
df_aid_sec_joined<-rbind(df_AID_dis50k_y %>% filter(year<2014),unocha_long) %>%
  arrange(year) %>%
  ungroup() %>%
  fill(year_mean_Hum_plus_ERaid)

df_aid_sec_joined$dummy_Hplus_ERaid<-ifelse(df_aid_sec_joined$Hum_plus_ER_aid_tot>df_aid_sec_joined$year_mean_Hum_plus_ERaid,1,0)

```

# Code GlobSol
```{r}
df= left_join(df_ICWES_dis50k_y, df_aid_sec_joined, by = c("year" = "year", "iso3c" = "iso3c"))
# drop NA agreement (keep only country years with disasters)
df<-Drop_NA(df, dummy_agreement)
#df<-Drop_NA(df, dummy_Hplus_ERaid)
# Replace post-2014 NA aid (disaster years) with 0 (low)
df$dummy_Hplus_ERaid<-ifelse(is.na(df$dummy_Hplus_ERaid), 0,df$dummy_Hplus_ERaid)
df<-df%>%filter(year<2020)

df <- df %>%
  mutate(GlobSol = case_when(
    dummy_agreement == 1 & dummy_Hplus_ERaid == 1 ~ 1,
    dummy_agreement == 1 & dummy_Hplus_ERaid == 0 ~ 2,
    dummy_agreement == 0 & dummy_Hplus_ERaid == 1 ~ 3,
    dummy_agreement == 0 & dummy_Hplus_ERaid == 0 ~ 4
  ))

table(df$GlobSol)
```

# Create compiled DF folder
```{r}
# Define the name of the folder to check/create
sub_folder_name <- "Compiled"
```

# Creating folder for datasets
```{r}

# Combine the desktop path with the folder name
folder_path <- file.path(desktop_path, main_folder_name,sub_folder_name)

# Check if the folder exists
if (!file.exists(folder_path)) {
  # If the folder doesn't exist, create it
  dir.create(folder_path)
  cat("Folder", main_folder_name, "created on the desktop.\n")
} else {
  # If the folder already exists, do nothing
  cat("Folder", main_folder_name, "already exists on the desktop.\n")
}
```
## Export dataset
```{r}

## create path
folder_path <- file.path(desktop_path, main_folder_name,sub_folder_name,"globsol_20240313.rds")

## save file
saveRDS(df,folder_path)

```


```{r}
ctrs_1<-subset(df, df$GlobSol==1)
ctrs_2<-subset(df, df$GlobSol==2)
ctrs_3<-subset(df, df$GlobSol==3)
ctrs_4<-subset(df, df$GlobSol==4)


sort(unique(ctrs_1$iso3c))
```


```{r}
sort(unique(ctrs_2$iso3c))
```


```{r}
sort(unique(ctrs_3$iso3c))
```


```{r}
sort(unique(ctrs_4$iso3c))
```


## experimenting visualizations

```{r}
# Rescale variables mean centred for each year

df_g <- df %>%
  mutate(aid_scaled = Hum_plus_ER_aid_tot-year_mean_Hum_plus_ERaid,
         Norm_scaled = NormAgr-year_mean_NormAgr)
  
```


```{r}
library(RColorBrewer)
#xlim<-mean(df_g$Norm_scaled)
#ylim<-mean(df_g$aid_scaled)

# Plot the dataset
p <- ggplot(data=df_g, aes(x = Norm_scaled, y = aid_scaled)) +
 geom_point(aes(colour = factor(GlobSol))) +
 #geom_text(aes(label=paste(iso3c,year)))+
 labs(x = "Normative agreement", y = "Sharing Behaviour") +
 geom_vline(xintercept = 0, linetype = "dashed", alpha=0.5) +
 geom_hline(yintercept = 0, linetype = "dashed", alpha=0.5) +
 scale_x_continuous(breaks=c(min(df_g$Norm_scaled)-14,0,max(df_g$Norm_scaled)),
                     labels=c("Low", "Mean","High"),
                     limits=c(min(df_g$Norm_scaled)-5,max(df_g$Norm_scaled)+5)) +
 scale_y_continuous(breaks=c(0,1500000000),
                    limits=c(-181435843,1500000000),
                     labels=c("Mean","High")) + 
 scale_colour_brewer(palette="Set1",name="Global Solidarity",
                     labels=c("Full",
                              "Symbolic",
                              "Coercive",
                              "Minimal")) +
 theme(panel.background = element_blank(),
        axis.ticks=element_blank(),
        legend.position=c(0.8,0.8))

print(p) + 
  ggtitle("Distribution of Normative Agreement and Sharing Behaviour, 1995-2019 \n(mean-centred by year)")

#ggsave("./plots/scatter_20240313.png", width=8,height=5)

```
## With labels
```{r}
library(ggrepel)

lab<-df_g %>% 
  mutate(label=
           ifelse(year=="2005" & iso3c=="USA","\nHurricane Katrina,  USA 2005", 
           ifelse(year=="2009" & iso3c=="TWN","\nTyphoon Morakot, Taiwan 2009",
           ifelse(year=="2005" & iso3c=="PAK"," \nKashmir Earthquake,\n Pakistan 2005",NA)))) %>%
    mutate(label2=
           ifelse(year=="2006" & iso3c=="SDN","Sudan\nFloods\n2006 ",NA)) %>%
  filter(!is.na(label)|!is.na(label2))


p+geom_text(data=lab,aes(x = Norm_scaled, y = aid_scaled, label=label,hjust=0.3, vjust=0.8))+
  geom_text(data=lab,aes(x = Norm_scaled, y = aid_scaled, label=label2),hjust=1.2)+
  geom_point(data=lab,aes(x = Norm_scaled, y = aid_scaled),shape=1,size=3) + 
  ggtitle("")

ggsave("./plots/labelled_scatter_20240823.png", width=8,height=5)


lab<-df_g %>% 
  mutate(label=
 ifelse(year=="2004" & iso3c=="IDN","Indonesia",
           ifelse(year=="2004" & iso3c=="THA","Thailand",
           ifelse(year=="2004" & iso3c=="SOM","Somalia",
           ifelse(year=="2004" & iso3c=="IND","\nIndia",
           ifelse(year=="2004" & iso3c=="LKA", "\nSri Lanka",NA)))))) %>%
  filter(!is.na(label))

add<-data.frame(year=2004,
                Norm_scaled=6.4+20.44+1.44-2.56,
                aid_scaled=108619633-7145305-20972991-3750192,
                label="Asian Tsunami")
lab2<-rbind(lab %>% select(c(year,Norm_scaled,aid_scaled,label)),add)                
                  
                  
p+geom_text_repel(data=lab2,aes(x = Norm_scaled, y = aid_scaled, label=label),
                  force=45)+
  geom_point(data=subset(lab2,label=="Asian Tsunami"))+
  geom_point(data=lab2,aes(x = Norm_scaled, y = aid_scaled),shape=1,size=3) + 
  ggtitle("Asian Tsunami 2004")

#ggsave("./plots/2004_scatter_20240823.png", width=8,height=5)

lab<-df_g %>% 
  mutate(label=
 ifelse(year=="2005" & iso3c=="IDN","Indonesia",
           ifelse(year=="2005" & iso3c=="THA","Thailand",
           ifelse(year=="2005" & iso3c=="SOM","Somalia",
           ifelse(year=="2005" & iso3c=="IND","India",
           ifelse(year=="2005" & iso3c=="LKA", "Sri Lanka",NA)))))) %>%
  filter(!is.na(label))

add<-data.frame(year=2005,
                Norm_scaled=18.903226+42.903226-9.096774-1.903226,
                aid_scaled=501130465+252954615+339708899+33043507,
              label="Asian Tsunami")
lab2<-rbind(lab %>% select(c(year,Norm_scaled,aid_scaled,label)),add)                
                  
                  
p+geom_text_repel(data=lab2,aes(x = Norm_scaled, y = aid_scaled, label=label),force=20,max.overlaps = 20)+
  geom_point(data=subset(lab2,label=="Asian Tsunami"))+
  geom_point(data=lab2,aes(x = Norm_scaled, y = aid_scaled),shape=1,size=3) + 
  ggtitle("Asian Tsunami (2005 impact)")

#ggsave("./plots/2005_scatter_20240315.png", width=8,height=5)

```



```{r}

xlim<-mean(df_g$year_mean_NormAgr)
ylim<-mean(df_g$year_mean_Hum_plus_ERaid)

# Plot the dataset
ggplot(df_g, aes(x = NormAgr, y = aid_scaled)) +
  geom_point() +
  labs(x = "NormAgr", y = "aid_scaled", title = "Scatter Plot of X1 vs X2")+
  geom_vline(xintercept = xlim, linetype = "dashed", color = "red") +
  geom_hline(yintercept = (ylim/100000), linetype = "dashed", color = "blue")+
  xlim(xlim - 15 , xlim + 45) +  # Adjust some_padding as needed
  ylim((ylim/100000)-800,(ylim/100000)+8000) + # Adjust some_padding as needed
  geom_point(aes(colour = factor(GlobSol)))+
  theme(panel.background = element_blank())+
  geom_vline(xintercept = 0, linetype = "dashed", color = "grey") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray")  




```

```{r}
df_t<-df

df_t$GlobSol <- factor(df_t$GlobSol)
df_t$year <- factor(df_t$year)

# Plotting using ggplot2 with stacked bars and year labels
ggplot(df_t, aes(x = year, fill = GlobSol)) +
  geom_bar(position = "stack",alpha=0.8) +
  labs(x = "Year", y = "Count", title = "Stacked Distribution of GlobSol Over Time")+
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        panel.background = element_blank())+
   scale_fill_brewer(palette="Set1",
                     labels=c("Cosmopolitan",
                              "Collective Action",
                              "Post-colonial",
                              "Communitarian"))# Tilting the x-axis labels by 45 degrees


#ggsave("./plots/stacked_20240313.png", width=10,height=6)
```


```{r}
# Assuming your dataset is named df
df_t_s <- df_t %>%
  group_by(year, GlobSol) %>%
  summarise(count = n()) %>%
  ungroup()


df_proportions <- df_t_s %>%
  group_by(year) %>%
  mutate(proportion = count / sum(count)) %>%
  ungroup()

# Now, plot the proportions over time
ggplot(df_proportions, aes(x = year, y = proportion, fill = factor(GlobSol))) +
  geom_bar(stat = "identity",alpha=0.8) +
  labs(x = "Year", y = "Proportion of Events", title = "Proportion of Events for Each Category of GlobSol Over Time") +
  scale_fill_brewer(palette="Set1", name = "GlobSol",
                     labels=c("Cosmopolitan",
                              "Collective Action",
                              "Post-colonial",
                              "Communitarian")) +  # Manually set colors for each category
    theme(axis.text.x = element_text(angle = 45, hjust = 1),
        panel.background = element_blank()) # Tilting the x-axis labels by 45 degrees

#ggsave("./plots/proportion_20240313.png", width=10,height=6)
```
```{r}
sum<-df_g %>%
  group_by(year) %>%
  arrange(year_mean_Hum_plus_ERaid) %>%
  slice(1)

ggplot(sum) +
  geom_line(aes(as.numeric(year),year_mean_NormAgr), colour="#003366",size=1)+
  labs(x = "Year", y = "Average number of countries", title = "Mean level of Normative Agreement Over Time") +
  scale_x_continuous(breaks=seq(1995,2019, by=1))+
   scale_y_continuous(breaks=seq(0,15, by=5))+
    theme(axis.text.x = element_text(angle = 45, hjust = 1),
        panel.background = element_blank())

#ggsave("./plots/mean_NormAgr_20240313.png", width=10,height=6)
  
ggplot(sum) +
geom_line(aes(year,year_mean_Hum_plus_ERaid/1000000), colour="#FD7702",size=1)+
    labs(x = "Year", y = "Average received (USD millions)", title = "Mean level of Sharing Behaviour Over Time") +
  scale_x_continuous(breaks=seq(1995,2019, by=1))+
   scale_y_continuous(breaks=seq(10,100, by=10))+
    theme(axis.text.x = element_text(angle = 45, hjust = 1),
        panel.background = element_blank())

#ggsave("./plots/mean_Sharing_20240313.png", width=10,height=6)
  

```

```{r}
# Reshape
df_t_s <- dcast(df_t_s, year ~ GlobSol)

df_t_s$sum<-df_t_s$`1`+df_t_s$`2`+df_t_s$`3`+df_t_s$`4`

df_t_s$op<-df_t_s$`1`/df_t_s$sum
df_t_s$tp<-df_t_s$`2`/df_t_s$sum
df_t_s$rp<-df_t_s$`3`/df_t_s$sum
df_t_s$fp<-df_t_s$`4`/df_t_s$sum
  
  
# Plotting using ggplot2 with unstacked bars and year labels
ggplot(df_t, aes(x = year, fill = GlobSol)) +
  geom_bar(position = "identity") +  # Change position to "identity"
  labs(x = "Year", y = "Count", title = "Distribution of GlobSol Over Years") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))  # Tilting the x-axis labels by 45 degrees
```

### ESD
#### Link df https://ucdp.uu.se/downloads/index.html#externalsupport
#### Create folder and download
```{r}
sub_folder_name<-"UCDP"
download_create_folder_and_unzip(desktop_path,
                           sub_folder_name,
                           "https://ucdp.uu.se/downloads/extsup/ESD/ucdp-esd-ty-181.zip")
```

#### Import
```{r}
file_path<-file.path(desktop_path,main_folder_name, sub_folder_name, "ucdp-esd-ty-181.dta")
## import  dataset
ESD<- haven::read_dta(file_path)
```

#### Reshaping dataset - calculating total amount of aid by type per recipient country per each year
```{r}
df_ESD<-ESD
##subset years
df_ESD<-subset(df_ESD, df_ESD$year>=1980)

## list var type of supports
all_vars <- names(df_ESD)
List <- all_vars[grep("^ext_", all_vars)]

## list vars of intrest
List2<-c("actor_name","year")
combined_list <- c(List, List2)

#select variables of interests
df_ESD<-df_ESD[c(combined_list)]

## keep only recipients that are governments
df_ESD <- subset(df_ESD, grepl("Government", actor_name))

## create iscode of recipient government
df_ESD <- df_ESD %>%
               mutate_at("actor_name", str_replace, "Government of ", "")

#assign ISO3
df_ESD$iso3c <- countrycode(df_ESD$actor_name, "country.name", "iso3c")

#drop iso3c NAs
df_ESD<-df_ESD[!is.na(df_ESD$iso3c), ]

## keep only support from state actors and coalitions
df_ESD<-subset(df_ESD, df_ESD$ext_nonstate==0)

## collapse at the level of the recipient country year
df_ESD_y<- df_ESD %>% 
  group_by(iso3c, year ) %>%
  summarize(N_funding = sum(ext_f),
            N_troops = sum(ext_x ),
            N_infra = sum(ext_y  ),
            N_weapons = sum(ext_w),
            N_logistics = sum(ext_m),
            N_training = sum(ext_t),
            N_intelligence = sum(ext_i),
            N_land = sum(ext_l),
            N_uknw = sum(ext_u))

## merge with Base
df_ESD_y= left_join(df_Base, df_ESD_y, by = c("year" = "year", "iso3c" = "iso3c"))

#list variables MDat
List<- colnames(df_ESD_y)[!colnames(df_ESD_y) %in% c("iso3c", "year")]

# assign 0s
df_ESD_y<-Nas_to_0(df_ESD_y,List)


# # Elements to drop
# elements_to_drop <- c("ext_id",
#                       "ext_name",
#                       "ext_nonstate",
#                       "ext_coalition",
#                       "ext_coalition_name",
#                       "ext_elements",
#                       "ext_bothsides",
#                       "ext_alleged",
#                       "ext_sum")

# Drop elements from the original list
#List_supp_type <- setdiff(List, elements_to_drop)

```
#### Reshaping dataset - calculating total amount of aid by type per each year
```{r}
df_ESD<-ESD
##subset years
df_ESD<-subset(df_ESD, df_ESD$year>=1980)


```

## Merge datasets
```{r}

```

## export final df
```{r}

```

